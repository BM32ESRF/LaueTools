

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LaueTools.CrystalParameters &mdash; LaueTools  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> LaueTools
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getStarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GUIs.html">Graphical User Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LaueToolsModules.html">LaueTools Modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LaueTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>LaueTools.CrystalParameters</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for LaueTools.CrystalParameters</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module belong to LaueTools package. It gathers procedures to define crystal</span>
<span class="sd">lattice parameters and strain calculations</span>

<span class="sd">Main authors are JS Micha, O. Robach, S. Tardif June 2019</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="c1">#import os</span>

<span class="c1"># sys.path.insert(0, os.path.abspath(&#39;../..&#39;))</span>
<span class="c1"># print(&#39;sys.path in CrystalParameters&#39;, sys.path)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">inv</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">ELASTICITYMODULE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">elasticity</span> <span class="k">as</span> <span class="n">el</span>
<span class="c1">#except (ImportError, ModuleNotFoundError):</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;elasticity.py module is missing. You may need it for very few usages&quot;</span><span class="p">)</span>
    <span class="n">ELASTICITYMODULE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="n">dict_LaueTools</span> <span class="kn">import</span> <span class="nn">dict_Materials</span><span class="o">,</span> <span class="nn">dict_Stiffness</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">generaltools</span> <span class="k">as</span> <span class="n">GT</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dict_LaueTools</span> <span class="k">import</span> <span class="n">dict_Materials</span><span class="p">,</span> <span class="n">dict_Stiffness</span>
    <span class="kn">import</span> <span class="nn">generaltools</span> <span class="k">as</span> <span class="nn">GT</span>

<span class="n">DEG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
<span class="n">RAD</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">DEG</span>
<span class="n">IDENTITYMATRIX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hasCubicSymmetry</span><span class="p">(</span><span class="n">key_material</span><span class="p">,</span> <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dict_Materials</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return True if material  has cubic symmetrys in LaueTools Dictionary</span>

<span class="sd">    :param key_material: material or structure label</span>
<span class="sd">    :type key_material: string</span>

<span class="sd">    :return: True or False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">latticeparams</span> <span class="o">=</span> <span class="n">dictmaterials</span><span class="p">[</span><span class="n">key_material</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">isCubic</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">isCubic</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param latticeparams: 6 elements list</span>
<span class="sd">    :type latticeparams: iterable object with float or integers elements</span>

<span class="sd">    :return: True or False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;latticeparams is not a list of the 6 lattice parameters&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;latticeparams is not a list of the 6 lattice parameters&quot;</span><span class="p">)</span>

    <span class="n">Cubic</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">latticeparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">latticeparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">latticeparams</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">latticeparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">latticeparams</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mf">90.0</span>
        <span class="ow">and</span> <span class="n">latticeparams</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mf">90.0</span>
        <span class="ow">and</span> <span class="n">latticeparams</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mf">90.0</span><span class="p">):</span>
        <span class="n">Cubic</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">Cubic</span>


<span class="k">def</span> <span class="nf">ApplyExtinctionrules</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">Extinc</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply selection rules to hkl reflections to remove forbidden ones</span>

<span class="sd">    :param HKL: numpy array (n,3) of [H,K,L]</span>
<span class="sd">    :param Extinc: label for extinction (see genHKL_np())</span>

<span class="sd">    :returns: numpy array (m,3) of [H,K,L]  m&lt;=n</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,)):</span>
        <span class="n">HKL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL</span><span class="p">)</span>

    <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">HKL</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nb of reflections before extinctions </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">HKL</span><span class="p">))</span>

    <span class="c1"># &#39;dia&#39; adds selection rules to those of &#39;fcc&#39;</span>
    <span class="k">if</span> <span class="n">Extinc</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fcc&quot;</span><span class="p">,</span> <span class="s2">&quot;dia&quot;</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">H</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;dia&quot;</span><span class="p">:</span>
            <span class="n">conddia</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span> <span class="o">*</span> <span class="n">conddia</span>

        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;bcc&quot;</span><span class="p">:</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;h+k=2n&quot;</span><span class="p">:</span>  <span class="c1"># group space 12  I2/m</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;h+k+l=2n&quot;</span><span class="p">:</span>  <span class="c1"># group space 139 indium</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;Al2O3&quot;</span><span class="p">:</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;Ti2AlN&quot;</span><span class="p">:</span>
        <span class="c1"># wurtzite condition</span>
        <span class="n">condfirst</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">==</span> <span class="n">K</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">L</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">array_hkl_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condfirst</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_1</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># other conditions due to symmetries</span>
        <span class="n">cond_lodd</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="n">cond_lodd</span> <span class="o">*</span> <span class="n">cond1</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;wurtzite&quot;</span><span class="p">:</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#         H, K, L = array_hkl_1.T</span>

    <span class="c1">#         cond3 = ((L) % 2 != 0)</span>
    <span class="c1">#         array_hkl_2 = np.delete(array_hkl_1, np.where(cond3 == True)[0], axis=0)</span>
    <span class="c1">#</span>
    <span class="c1">#         H, K, L = array_hkl_2.T</span>

    <span class="c1">#         cond4 = ((L) % 2 == 0)</span>
    <span class="c1">#         cond5 = (((H - K) % 3) != 0)</span>
    <span class="c1">#</span>
    <span class="c1">#         cond6 = cond4 * cond5</span>
    <span class="c1">#</span>
    <span class="c1">#         array_hkl = np.take(array_hkl_1, np.where(cond6 == True)[0], axis=0)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;magnetite&quot;</span><span class="p">:</span>  <span class="c1"># GS 227</span>
        <span class="c1"># TODO not working ...</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">array_hkl_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl_1</span><span class="p">))</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_1</span><span class="o">.</span><span class="n">T</span>

        <span class="n">cond0kl_1</span> <span class="o">=</span> <span class="p">((</span><span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cond0kl_2</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cond0kl_3</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">cond0kl</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond0kl_1</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond0kl_2</span> <span class="o">+</span> <span class="p">(</span><span class="n">L</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond0kl_3</span>

        <span class="n">array_hkl_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond0kl</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl_2</span><span class="p">))</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_2</span><span class="o">.</span><span class="n">T</span>

        <span class="n">condhhl_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">==</span> <span class="n">K</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">condhhl_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">==</span> <span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">L</span> <span class="o">+</span> <span class="n">H</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">condhhl_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">==</span> <span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">condhhl</span> <span class="o">=</span> <span class="n">condhhl_1</span> <span class="o">+</span> <span class="n">condhhl_2</span> <span class="o">+</span> <span class="n">condhhl_3</span>

        <span class="n">array_hkl_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condhhl</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len 3&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl_3</span><span class="p">))</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_3</span><span class="o">.</span><span class="n">T</span>

        <span class="n">condh00_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">condh00_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">condh00_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">condh00</span> <span class="o">=</span> <span class="n">condh00_1</span> <span class="o">+</span> <span class="n">condh00_2</span> <span class="o">+</span> <span class="n">condh00_3</span>

        <span class="n">array_hkl_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condh00</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len f&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl_0</span><span class="p">))</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_0</span><span class="o">.</span><span class="n">T</span>

        <span class="n">cond8a</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">L</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">((</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">array_hkl_00</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array_hkl_0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond8a</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl_00</span><span class="p">))</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_00</span><span class="o">.</span><span class="n">T</span>

        <span class="n">cond16d</span> <span class="o">=</span> <span class="p">(((</span><span class="n">H</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">L</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
            <span class="o">+</span> <span class="p">((</span><span class="n">H</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">+</span> <span class="p">((</span><span class="n">H</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond16d</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;Al2O3_rhombo&quot;</span><span class="p">:</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">cond1</span> <span class="o">*</span> <span class="n">cond2</span> <span class="o">*</span> <span class="n">cond3</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;VO2_mono&quot;</span><span class="p">:</span>
        <span class="n">cond1a</span> <span class="o">=</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond1b</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="n">cond1a</span> <span class="o">*</span> <span class="n">cond1b</span>

        <span class="n">array_hkl_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_1</span><span class="o">.</span><span class="n">T</span>

        <span class="n">cond2a</span> <span class="o">=</span> <span class="n">H</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2b</span> <span class="o">=</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2c</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">cond2</span> <span class="o">=</span> <span class="n">cond2a</span> <span class="o">*</span> <span class="n">cond2b</span> <span class="o">*</span> <span class="n">cond2c</span>
        <span class="n">array_hkl_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cond3a</span> <span class="o">=</span> <span class="n">H</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond3b</span> <span class="o">=</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond3c</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond3</span> <span class="o">=</span> <span class="n">cond3a</span> <span class="o">*</span> <span class="n">cond3b</span> <span class="o">*</span> <span class="n">cond3c</span>

        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond3</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;VO2_mono2&quot;</span><span class="p">:</span>

        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">array_hkl_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_1</span><span class="o">.</span><span class="n">T</span>

        <span class="n">cond2a</span> <span class="o">=</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2c</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">cond2</span> <span class="o">=</span> <span class="n">cond2a</span> <span class="o">*</span> <span class="n">cond2c</span>
        <span class="n">array_hkl_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cond3a</span> <span class="o">=</span> <span class="n">H</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond3c</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond3</span> <span class="o">=</span> <span class="n">cond3a</span> <span class="o">*</span> <span class="n">cond3c</span>

        <span class="n">array_hkl_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond3</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cond4a</span> <span class="o">=</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond4c</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond4</span> <span class="o">=</span> <span class="n">cond4a</span> <span class="o">*</span> <span class="n">cond4c</span>

        <span class="n">array_hkl_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond4</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cond5a</span> <span class="o">=</span> <span class="n">H</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond5b</span> <span class="o">=</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond5c</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond5</span> <span class="o">=</span> <span class="n">cond5a</span> <span class="o">*</span> <span class="n">cond5b</span> <span class="o">*</span> <span class="n">cond5c</span>

        <span class="n">array_hkl_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond5</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cond6a</span> <span class="o">=</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond6b</span> <span class="o">=</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond6c</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond6</span> <span class="o">=</span> <span class="n">cond6a</span> <span class="o">*</span> <span class="n">cond6b</span> <span class="o">*</span> <span class="n">cond6c</span>

        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond6</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Extinc</span> <span class="o">==</span> <span class="s2">&quot;rutile&quot;</span><span class="p">:</span>

        <span class="n">cond1a</span> <span class="o">=</span> <span class="n">H</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond1b</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="n">cond1a</span> <span class="o">*</span> <span class="n">cond1b</span>

        <span class="n">array_hkl_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">array_hkl_1</span><span class="o">.</span><span class="n">T</span>

        <span class="n">cond2a</span> <span class="o">=</span> <span class="n">H</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2b</span> <span class="o">=</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond2c</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">cond2</span> <span class="o">=</span> <span class="n">cond2a</span> <span class="o">*</span> <span class="n">cond2b</span> <span class="o">*</span> <span class="n">cond2c</span>
        <span class="n">array_hkl_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cond3a</span> <span class="o">=</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond3b</span> <span class="o">=</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cond3c</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">cond3</span> <span class="o">=</span> <span class="n">cond3a</span> <span class="o">*</span> <span class="n">cond3b</span> <span class="o">*</span> <span class="n">cond3c</span>

        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond3</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># no extinction rules</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">HKL</span>

    <span class="c1"># removing the node 000</span>
    <span class="n">pos000</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">array_hkl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#     print &#39;pos000&#39;, pos000</span>
    <span class="n">array_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_hkl</span><span class="p">,</span> <span class="n">pos000</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nb of reflections after extinctions </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_hkl</span><span class="p">))</span>

    <span class="c1">#     print &quot;shape array_hkl&quot;, np.shape(array_hkl)</span>
    <span class="c1">#     print array_hkl[:5]</span>
    <span class="k">return</span> <span class="n">array_hkl</span>


<div class="viewcode-block" id="GrainParameter_from_Material"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.GrainParameter_from_Material">[docs]</a><span class="k">def</span> <span class="nf">GrainParameter_from_Material</span><span class="p">(</span><span class="n">key_material</span><span class="p">,</span> <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dict_Materials</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create grain parameters list for the Laue pattern simulation</span>

<span class="sd">    Can handle material defined in dictionary by four elements instead of 6 lattice parameters</span>

<span class="sd">    :param key_material: material or structure label</span>
<span class="sd">    :type key_material: string</span>

<span class="sd">    :return: grain (4 elements list),  contains_U (boolean)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">elem_key</span><span class="p">,</span> <span class="n">unitCellparameters</span><span class="p">,</span> <span class="n">Structure_extinction</span> <span class="o">=</span> <span class="n">dictmaterials</span><span class="p">[</span><span class="n">key_material</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Unknown key &#39;</span><span class="si">%s</span><span class="s2">&#39;for material&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_material</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unitCellparameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># a,b,c,alpha,beta,gamma</span>

        <span class="n">Bmat</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">unitCellparameters</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Gstar = CP.Gstar_from_directlatticeparams(unitCellparameters*)</span>

        <span class="n">grain</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bmat</span><span class="p">,</span> <span class="n">Structure_extinction</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">elem_key</span><span class="p">]</span>
        <span class="n">contains_U</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># U matrix needs to be added in grain</span>

    <span class="c1"># 4 operators Da, U, B, Dc</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unitCellparameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">Da</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Dc</span> <span class="o">=</span> <span class="n">unitCellparameters</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Da&quot;</span><span class="p">,</span> <span class="n">Da</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Dc</span><span class="p">)</span>
        <span class="n">Bmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dc</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">Umat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Da</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="n">grain</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bmat</span><span class="p">,</span> <span class="n">Structure_extinction</span><span class="p">,</span> <span class="n">Umat</span><span class="p">,</span> <span class="n">elem_key</span><span class="p">]</span>
        <span class="n">contains_U</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Something is wrong in the material definition in dict_Materials&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grain</span><span class="p">,</span> <span class="n">contains_U</span></div>


<span class="k">def</span> <span class="nf">isOrientMatrix</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    test simply if the matrix is inversible</span>

<span class="sd">    :param mat: matrix</span>
<span class="sd">    :type mat: numpy.array or list</span>

<span class="sd">    :return: boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;OrientMatrix is not a matrix!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;OrientMatrix has determinant equals to 0!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="Prepare_Grain"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.Prepare_Grain">[docs]</a><span class="k">def</span> <span class="nf">Prepare_Grain</span><span class="p">(</span><span class="n">key_material</span><span class="p">,</span> <span class="n">OrientMatrix</span><span class="p">,</span> <span class="n">force_extinction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dict_Materials</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructor of the grain (crystal) parameters for Laue pattern simulation</span>

<span class="sd">    if in key_material definition (see dict_Materials) orient matrix is missing</span>
<span class="sd">    (i.e. only lattice parameter are input)</span>

<span class="sd">    :param key_material: material label</span>
<span class="sd">    :type key_material: str</span>

<span class="sd">    then list parameter will consider the provided value of the optional</span>
<span class="sd">    OrientMatrix argument</span>

<span class="sd">    :param force_extinction:  None, use default extinction rules,</span>
<span class="sd">            otherwise use other extinction correspondoing to the label</span>
<span class="sd">    :type force_extinction: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">key_material</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dictmaterials</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is unknown! You need to create before using&quot;</span>
            <span class="s2">&quot; Prepare_Grain.&quot;</span> <span class="o">%</span> <span class="n">key_material</span><span class="p">)</span>

    <span class="n">grain</span><span class="p">,</span> <span class="n">contains_U</span> <span class="o">=</span> <span class="n">GrainParameter_from_Material</span><span class="p">(</span><span class="n">key_material</span><span class="p">,</span> <span class="n">dictmaterials</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">force_extinction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_extinction</span>

    <span class="k">if</span> <span class="n">contains_U</span><span class="p">:</span>  <span class="c1"># grain contains an orient matrix</span>
        <span class="k">return</span> <span class="n">grain</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">OrientMatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isOrientMatrix</span><span class="p">(</span><span class="n">OrientMatrix</span><span class="p">):</span>
                <span class="n">grain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrientMatrix</span>
            <span class="k">return</span> <span class="n">grain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;An OrientMatrix is needed !!! in Prepare_Grain()&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AngleBetweenNormals"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.AngleBetweenNormals">[docs]</a><span class="k">def</span> <span class="nf">AngleBetweenNormals</span><span class="p">(</span><span class="n">HKL1s</span><span class="p">,</span> <span class="n">HKL2s</span><span class="p">,</span> <span class="n">Gstar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute pairwise angles (in degrees) between reflections or lattice plane normals</span>
<span class="sd">    of two sets according to unit cell metrics Gstar</span>

<span class="sd">    :param  HKL1s: list of [H1,K1,L1]</span>
<span class="sd">    :param  HKL2s: list of [H2,K2,L2]</span>
<span class="sd">    :param Gstar: 3*3 matrix corresponding to reciprocal metric tensor of unit cell (as provided by Gstar_from_directlatticeparams())</span>

<span class="sd">    :return: array of pairwise angles between reflections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HKL1r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL1s</span><span class="p">)</span>
    <span class="n">HKL2r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL2s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">GT</span><span class="o">.</span><span class="n">AngleBetweenVectors</span><span class="p">(</span><span class="n">HKL1r</span><span class="p">,</span> <span class="n">HKL2r</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">Gstar</span><span class="p">)</span></div>


<div class="viewcode-block" id="FilterHarmonics_2"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.FilterHarmonics_2">[docs]</a><span class="k">def</span> <span class="nf">FilterHarmonics_2</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span> <span class="n">return_indices_toremove</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    keep only hkl 3d vectors that are representative of direction nh,nk,nl</span>
<span class="sd">    for any h,k,l signed integers</span>

<span class="sd">    It removes only parallel vector but KEEPs antiparallel vectors (vec , -n vec) with n&gt;0</span>

<span class="sd">    :param hkl: array of 3d hkl indices</span>
<span class="sd">    :param return_indices_toremove: 1, returns indices of element in hkl that have been removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hkl&quot;</span><span class="p">,</span> <span class="n">hkl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len(hkl)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hkl</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hkl.type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hkl</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;hkl is not an array!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># print &quot;input array has only one element!&quot;</span>
        <span class="k">return</span> <span class="n">hkl</span>
    <span class="c1"># square array with element[i,j] = angle between hkl[i] and hkl[j]</span>
    <span class="n">nb_hkl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">AngleBetweenNormals</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span> <span class="n">hkl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">ind_in_flat_a</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">indices_in_flatTriuMatrix</span><span class="p">(</span><span class="n">nb_hkl</span><span class="p">)</span>
    <span class="c1"># 1D array</span>
    <span class="n">angle_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">ind_in_flat_a</span><span class="p">)</span>

    <span class="c1"># index of zeros</span>
    <span class="n">pos_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">angle_pairs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># print &quot;pos_zeros&quot;,pos_zeros</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_zeros</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hkls_pairs_index</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">indices_in_TriuMatrix</span><span class="p">(</span><span class="n">ind_in_flat_a</span><span class="p">[</span><span class="n">pos_zeros</span><span class="p">],</span> <span class="n">nb_hkl</span><span class="p">)</span>
        <span class="n">cliques_of_harmonics</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">getSets</span><span class="p">(</span><span class="n">hkls_pairs_index</span><span class="p">)</span>

        <span class="n">allelem_in_cliques</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cli</span> <span class="ow">in</span> <span class="n">cliques_of_harmonics</span><span class="p">:</span>
            <span class="n">allelem_in_cliques</span> <span class="o">+=</span> <span class="n">cli</span>
        <span class="n">initial_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allelem_in_cliques</span><span class="p">)</span>
        <span class="c1">#        print &quot;initial toremove_set&quot;, allelem_in_cliques</span>

        <span class="n">tokeep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">clique</span> <span class="ow">in</span> <span class="n">cliques_of_harmonics</span><span class="p">:</span>
            <span class="c1">#            print &quot;clique&quot;, clique</span>
            <span class="n">abshkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span> <span class="n">clique</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">fond_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">abshkl</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1">#            print abshkl</span>
            <span class="c1">#            print fond_index</span>
            <span class="c1">#            print &quot;tokeep&quot;, clique[fond_index]</span>
            <span class="n">tokeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clique</span><span class="p">[</span><span class="n">fond_index</span><span class="p">])</span>

        <span class="n">toremove</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_set</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokeep</span><span class="p">))</span>
        <span class="n">filtered_hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span> <span class="n">toremove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_indices_toremove</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered_hkl</span><span class="p">,</span> <span class="n">toremove</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered_hkl</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#         print &quot;hkl doesn&#39;t contain harmonics ...&quot;</span>
        <span class="k">if</span> <span class="n">return_indices_toremove</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hkl</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hkl</span></div>


<span class="c1"># ---- -----Unit Cell parameters - Reciprocal and Direct Lattice Parameters  -----</span>
<div class="viewcode-block" id="calc_B_RR"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.calc_B_RR">[docs]</a><span class="k">def</span> <span class="nf">calc_B_RR</span><span class="p">(</span><span class="n">latticeparameters</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">setvolume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Calculate B0 matrix (columns = vectors a*,b*,c*) from direct (real) space lattice parameters (directspace=1)</span>
<span class="sd">    * Calculate a matrix (columns = vectors a,b,c) from direct (real) space lattice parameters (directspace=0)</span>

<span class="sd">    :math:`\boldsymbol q_{ortho}=B_0 {\bf G^*}` where :math:`{\bf G^*}=h{\bf a^*}+k{\bf b^*}+l{\bf c^*}`</span>

<span class="sd">    :param latticeparameters:</span>
<span class="sd">        * [a,b,c, alpha, beta, gamma]    (angles are in degrees) if directspace=1</span>
<span class="sd">        * [a*,b*,c*, alpha*, beta*, gamma*] (angles are in degrees) if directspace=0</span>
<span class="sd">    :param directspace:</span>
<span class="sd">        * 1 (default) converts  (reciprocal) direct lattice parameters</span>
<span class="sd">            to (direct) reciprocal space calculates &quot;B&quot; matrix in the reciprocal space of input latticeparameters</span>
<span class="sd">        * 0  converts  (reciprocal) direct lattice parameters to (reciprocal) direct space</span>
<span class="sd">            calculates &quot;B&quot; matrix in same space of  input latticeparameters</span>

<span class="sd">    :param setvolume:</span>
<span class="sd">        * False, sets direct unit cell volume to the true volume from lattice parameters</span>
<span class="sd">        * 1,      sets direct unit cell volume to 1</span>
<span class="sd">        * &#39;a**3&#39;,  sets direct unit cell volume to a**3</span>
<span class="sd">        * &#39;b**3&#39;, sets direct unit cell volume to b**3</span>
<span class="sd">        * &#39;c**3&#39;,  sets direct unit cell volume to c**3</span>

<span class="sd">    :return: B Matrix (triangular up) from  crystal (reciprocal space) frame to orthonormal frame matrix</span>
<span class="sd">    :rtype: numpy array</span>

<span class="sd">    B matrix is used in q=U B G* formula or</span>
<span class="sd">        as B0  in q= (UB) B0 G*</span>

<span class="sd">    after Busing Levy, Acta Crysta 22 (1967), p 457</span>

<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">            \left( \begin{matrix}</span>
<span class="sd">            a^*  &amp; b^*\cos \gamma^* &amp; c^*\cos beta^*\\</span>
<span class="sd">            0  &amp; b^*\sin \gamma^* &amp;-c^*\sin \beta^*\cos \alpha\\</span>
<span class="sd">            0 &amp;  0    &amp;      c^*\sin \beta^*\sin \alpha\\</span>
<span class="sd">                    \end{matrix} \right)</span>

<span class="sd">    with</span>

<span class="sd">    .. math :: \cos(\alpha)=(\cos \beta^*\cos \gamma^*-\cos \alpha^*)/(\sin \beta^*\sin \gamma^*)</span>

<span class="sd">    and</span>

<span class="sd">    .. math :: c^* \sin \beta^* \sin \alpha = 1/c</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">latticeparameters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">directspace</span><span class="p">:</span>  <span class="c1"># from lattice param in one space to a matrix in other space</span>
        <span class="n">rlat</span> <span class="o">=</span> <span class="n">dlat_to_rlat</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">setvolume</span><span class="o">=</span><span class="n">setvolume</span><span class="p">)</span>

        <span class="n">rlat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">DEG</span>  <span class="c1"># convert angles elements in radians</span>

        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">DEG</span><span class="p">)</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">DEG</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">B</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># from lattice parameters in one space to a matrix in the same space</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">lat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">DEG</span>  <span class="c1"># convert angles elements in radians</span>

        <span class="c1"># A = B[0,0]x</span>
        <span class="c1"># B = B[0,1]x+B[1,1]y</span>
        <span class="c1"># C = B[0,2]x+B[1,2]y+B[2,2]</span>
        <span class="c1"># A=(a,0,0)</span>
        <span class="c1"># B=(bcosgam,bsingam,0)</span>
        <span class="c1"># C=(ccosbeta,c/singamma*(cosalpha-cosgamma*cosbeta),0)</span>
        <span class="c1"># C=(cx,cy,c*sqrt(1-cx**2-cy**2))</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># gamma angle</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># beta angle</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">B</span></div>


<span class="c1"># ---- ----------------------Strain computations --------------</span>
<div class="viewcode-block" id="DeviatoricStrain_LatticeParams"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.DeviatoricStrain_LatticeParams">[docs]</a><span class="k">def</span> <span class="nf">DeviatoricStrain_LatticeParams</span><span class="p">(</span><span class="n">newUBmat</span><span class="p">,</span> <span class="n">latticeparams</span><span class="p">,</span> <span class="n">constantlength</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes deviatoric strain and new direct (real) lattice parameters</span>
<span class="sd">    from matrix newUBmat (rotation and deformation)</span>
<span class="sd">    considering that one lattice length is chosen to be constant</span>

<span class="sd">    Zero strain corresponds to reference state of input `lattice parameters`</span>

<span class="sd">    :param newUBmat: (3x3) matrix operator including rotation and deformation</span>
<span class="sd">    :param latticeparams: 6 lattice parameters  [a,b,c,:math:`\alpha, \beta, \gamma`] in Angstrom and degrees</span>
<span class="sd">    :param constantlength: &#39;a&#39;,&#39;b&#39;, or &#39;c&#39; to set one length according to the value in `latticeparams`</span>

<span class="sd">    :returns: * 3x3 deviatoric strain tensor)</span>
<span class="sd">            * lattice_parameter_direct_strain (direct (real) lattice parameters)</span>
<span class="sd">    :rtype: 3x3 numpy array, 6 elements list</span>

<span class="sd">    .. note::</span>

<span class="sd">        * q = newUBmat . B0 . G*  where B0 (triangular up matrix) comes from lattice parameters input.</span>

<span class="sd">        * equivalently, q = UBstar_s . G*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># q = newUBmat . B0 . G*  where B0 (triangular up matrix) comes from lattice parameters input</span>
    <span class="c1"># q = UBstar_s . G*</span>
    <span class="c1"># print &quot;new UBs matrix in q= UBs G&quot;</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">)</span>
    <span class="n">UBstar_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newUBmat</span><span class="p">,</span> <span class="n">B0</span><span class="p">)</span>
    <span class="c1"># print UBstar_s</span>

    <span class="n">lattice_parameter_reciprocal</span> <span class="o">=</span> <span class="n">matrix_to_rlat</span><span class="p">(</span><span class="n">UBstar_s</span><span class="p">)</span>
    <span class="n">lattice_parameter_direct_strain</span> <span class="o">=</span> <span class="n">dlat_to_rlat</span><span class="p">(</span><span class="n">lattice_parameter_reciprocal</span><span class="p">)</span>

    <span class="n">Bmatrix_direct_strain</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">lattice_parameter_direct_strain</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Bmatrix_direct_unstrained</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">Trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Bmatrix_direct_strain</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Bmatrix_direct_unstrained</span><span class="p">))</span>
    <span class="n">strain_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">Trans</span> <span class="o">+</span> <span class="n">Trans</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">IDENTITYMATRIX</span>

    <span class="c1"># print &quot;strain_direct&quot;,strain_direct</span>

    <span class="n">devstrain</span> <span class="o">=</span> <span class="n">strain_direct</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">strain_direct</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">IDENTITYMATRIX</span>

    <span class="c1"># print &quot;deviatoric strain&quot;, devstrain</span>

    <span class="c1"># print &quot;final lattice parameter&quot;</span>
    <span class="c1"># print &quot;a set reference a = %.5f Angstroms&quot;%latticeparams[0]</span>

    <span class="c1"># since absolute scale is unknown , lattice parameter are rescaled with a_reference</span>

    <span class="c1"># rescaling to set one length of lattice to its original value</span>
    <span class="k">if</span> <span class="n">constantlength</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
        <span class="n">index_constant_length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">constantlength</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
        <span class="n">index_constant_length</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">constantlength</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
        <span class="n">index_constant_length</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For comparison: a,b,c are rescaled with respect to the reference value of </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%f</span><span class="s2"> Angstroms&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">constantlength</span><span class="p">,</span> <span class="n">latticeparams</span><span class="p">[</span><span class="n">index_constant_length</span><span class="p">]))</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">latticeparams</span><span class="p">[</span><span class="n">index_constant_length</span><span class="p">]</span>
        <span class="o">/</span> <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="n">index_constant_length</span><span class="p">])</span>
    <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>
    <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>
    <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lattice_parameter_direct_strain&quot;</span><span class="p">,</span> <span class="n">lattice_parameter_direct_strain</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">devstrain</span><span class="p">,</span> <span class="n">lattice_parameter_direct_strain</span></div>


<span class="k">def</span> <span class="nf">evaluate_strain_fromUBmat</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">key_material</span><span class="p">,</span> <span class="n">constantlength</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dict_Materials</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate strain from UBmat matrix  (q = UBmat B0 G*)</span>

<span class="sd">    :returns:   devstrain, deviatoricstrain_sampleframe, lattice_parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute new lattice parameters  -----</span>
    <span class="n">latticeparams</span> <span class="o">=</span> <span class="n">dictmaterials</span><span class="p">[</span><span class="n">key_material</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">B0matrix</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">)</span>

    <span class="n">UBmat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">UBmat</span><span class="p">)</span>

    <span class="p">(</span><span class="n">devstrain</span><span class="p">,</span> <span class="n">lattice_parameters</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_deviatoricstrain</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">B0matrix</span><span class="p">,</span> <span class="n">latticeparams</span><span class="p">)</span>
    <span class="c1"># overwrite and rescale possibly lattice lengthes</span>
    <span class="n">lattice_parameters</span> <span class="o">=</span> <span class="n">computeLatticeParameters_from_UB</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">key_material</span><span class="p">,</span> <span class="n">constantlength</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final lattice_parameters&quot;</span><span class="p">,</span> <span class="n">lattice_parameters</span><span class="p">)</span>

    <span class="n">deviatoricstrain_sampleframe</span> <span class="o">=</span> <span class="n">strain_from_crystal_to_sample_frame2</span><span class="p">(</span><span class="n">devstrain</span><span class="p">,</span> <span class="n">UBmat</span><span class="p">)</span>

    <span class="c1"># devstrain_sampleframe_round = np.round(</span>
    <span class="c1">#     deviatoricstrain_sampleframe * 1000, decimals=3</span>
    <span class="c1"># )</span>
    <span class="c1"># devstrain_round = np.round(devstrain * 1000, decimals=3)</span>

    <span class="k">return</span> <span class="n">devstrain</span><span class="p">,</span> <span class="n">deviatoricstrain_sampleframe</span><span class="p">,</span> <span class="n">lattice_parameters</span>


<span class="k">def</span> <span class="nf">compute_deviatoricstrain</span><span class="p">(</span><span class="n">newUBmat</span><span class="p">,</span> <span class="n">B0matrix</span><span class="p">,</span> <span class="n">latticeparams</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # starting B0matrix corresponding to the unit cell   -----</span>
<span class="sd">        latticeparams = DictLT.dict_Materials[key_material][1]</span>
<span class="sd">        B0matrix = CP.calc_B_RR(latticeparams)</span>

<span class="sd">        q = newUBmat B0 G*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new UBs matrix in q= UBs G (s for strain)&quot;</span><span class="p">)</span>

    <span class="n">Bstar_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newUBmat</span><span class="p">,</span> <span class="n">B0matrix</span><span class="p">)</span>
    <span class="c1">#     print Bstar_s</span>

    <span class="n">lattice_parameter_reciprocal</span> <span class="o">=</span> <span class="n">matrix_to_rlat</span><span class="p">(</span><span class="n">Bstar_s</span><span class="p">)</span>
    <span class="n">lattice_parameter_direct_strain</span> <span class="o">=</span> <span class="n">dlat_to_rlat</span><span class="p">(</span><span class="n">lattice_parameter_reciprocal</span><span class="p">)</span>

    <span class="n">Bmatrix_direct_strain</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">lattice_parameter_direct_strain</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Bmatrix_direct_unstrained</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">Trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Bmatrix_direct_strain</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Bmatrix_direct_unstrained</span><span class="p">))</span>
    <span class="c1"># keeping non rotating part (symmetrical)</span>
    <span class="n">strain_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">Trans</span> <span class="o">+</span> <span class="n">Trans</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;strain_direct&quot;</span><span class="p">,</span> <span class="n">strain_direct</span><span class="p">)</span>

    <span class="n">devstrain</span> <span class="o">=</span> <span class="n">strain_direct</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">strain_direct</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deviatoric strain&quot;</span><span class="p">,</span> <span class="n">devstrain</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">devstrain</span><span class="p">,</span> <span class="n">lattice_parameter_direct_strain</span>


<span class="k">def</span> <span class="nf">computeLatticeParameters_from_UB</span><span class="p">(</span><span class="n">UBmatrix</span><span class="p">,</span> <span class="n">key_material</span><span class="p">,</span>
                                            <span class="n">constantlength</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dictmaterials</span><span class="o">=</span><span class="n">dict_Materials</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes  direct (real) lattice parameters</span>
<span class="sd">    from matrix UBmatrix (rotation and deformation)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># starting B0matrix corresponding to the unit cell   -----</span>
    <span class="n">latticeparams</span> <span class="o">=</span> <span class="n">dictmaterials</span><span class="p">[</span><span class="n">key_material</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">B0matrix</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">latticeparams</span><span class="p">)</span>

    <span class="n">UBmat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">UBmatrix</span><span class="p">)</span>

    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">lattice_parameter_direct_strain</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_deviatoricstrain</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">B0matrix</span><span class="p">,</span> <span class="n">latticeparams</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">constantlength</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
        <span class="n">index_constant_length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">constantlength</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
        <span class="n">index_constant_length</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">constantlength</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
        <span class="n">index_constant_length</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;For comparison: a,b,c are rescaled with respect to the reference value of </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%f</span><span class="s2"> Angstroms&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">constantlength</span><span class="p">,</span> <span class="n">latticeparams</span><span class="p">[</span><span class="n">index_constant_length</span><span class="p">]))</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">latticeparams</span><span class="p">[</span><span class="n">index_constant_length</span><span class="p">]</span>
        <span class="o">/</span> <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="n">index_constant_length</span><span class="p">])</span>
    <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>
    <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>
    <span class="n">lattice_parameter_direct_strain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lattice_parameter_direct_strain&quot;</span><span class="p">,</span> <span class="n">lattice_parameter_direct_strain</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lattice_parameter_direct_strain</span>


<span class="k">def</span> <span class="nf">computeDirectUnitCell_from_Bmatrix</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    computes direct space unit cell lattice parameters from Bmatrix</span>
<span class="sd">    (i.e. columns are unit cell basis vector a,b,c in absolute Lauetools frame).</span>

<span class="sd">    Computes a,b,c from a*,b*,c*</span>

<span class="sd">    Corresponds to Matrix from real unit cell frame to reciprocal unit cell frame</span>
<span class="sd">    V)in a*,b*,c* = P * V)in a,b,c</span>

<span class="sd">    :param Bmatrix: Matrix (3x3) whose columns are a*,*b,c* reciprocal unit cell vectors</span>
<span class="sd">    expressed in LaueTools frame</span>
<span class="sd">    :type Bmatrix: numpy array</span>

<span class="sd">    :returns: matrix (3x3) whose columns are a,b,c expressed in LaueTools frame</span>
<span class="sd">    :rtype: numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Bm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">)</span>
    <span class="n">Astar</span><span class="p">,</span> <span class="n">Bstar</span><span class="p">,</span> <span class="n">Cstar</span> <span class="o">=</span> <span class="n">Bm</span><span class="o">.</span><span class="n">T</span>
    <span class="n">volumestar</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Astar</span><span class="p">,</span> <span class="n">Bstar</span><span class="p">),</span> <span class="n">Cstar</span><span class="p">)</span>
    <span class="c1"># print(&quot;volumestar&quot;, volumestar)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Bstar</span><span class="p">,</span> <span class="n">Cstar</span><span class="p">)</span> <span class="o">/</span> <span class="n">volumestar</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Cstar</span><span class="p">,</span> <span class="n">Astar</span><span class="p">)</span> <span class="o">/</span> <span class="n">volumestar</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Astar</span><span class="p">,</span> <span class="n">Bstar</span><span class="p">)</span> <span class="o">/</span> <span class="n">volumestar</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>


<span class="k">def</span> <span class="nf">mat_to_rlat</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes reciprocal lattice parameters from orientation and deformation matrix</span>

<span class="sd">    :param matstarlab: 9 elements inline matrix</span>
<span class="sd">    :returns: 6 reciprocal unit cell lattice parameters</span>

<span class="sd">    .. note:: from Odile&#39;s scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">astarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">cstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">norme</span><span class="p">(</span><span class="n">astarlab</span><span class="p">)</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">norme</span><span class="p">(</span><span class="n">bstarlab</span><span class="p">)</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">norme</span><span class="p">(</span><span class="n">cstarlab</span><span class="p">)</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">astarlab</span><span class="p">,</span> <span class="n">bstarlab</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">cstarlab</span><span class="p">,</span> <span class="n">astarlab</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">bstarlab</span><span class="p">,</span> <span class="n">cstarlab</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># print &quot;rlat = &quot;,rlat</span>

    <span class="k">return</span> <span class="n">rlat</span>

<span class="k">def</span> <span class="nf">rlat_to_Bstar</span><span class="p">(</span><span class="n">rlat</span><span class="p">):</span>  <span class="c1"># 29May13</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # Xcart = Bstar*Xcrist_rec</span>
<span class="sd">        # changement de coordonnees pour le vecteur X entre</span>
<span class="sd">        # le repere de la maille reciproque Rcrist_rec</span>
<span class="sd">        # et le repere OND Rcart associe a Rcrist_rec</span>
<span class="sd">        # rlat  reciprocal lattice parameters</span>
<span class="sd">        # dlat  direct lattice parameters</span>
<span class="sd">        # en radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">Bstar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">dlat_to_rlat</span><span class="p">(</span><span class="n">rlat</span><span class="p">)</span>

    <span class="n">Bstar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Bstar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">Bstar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">Bstar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">Bstar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Bstar</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Bstar</span>

<span class="k">def</span> <span class="nf">fromrealframe_to_reciprocalframe</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes :math:`{\bf X_{recipr}}` (components of `vector`  in reciprocal unit cell vectors basis)</span>
<span class="sd">        from  `vector` (:math:`{\bf X_{real}}`, expressed in real a,b,c unit cell vectors basis)</span>

<span class="sd">    :param Bmatrix: Matrix whose columns are a*,b*,c* vectors in LaueTools frame</span>
<span class="sd">    :param vector: 3 elements array of components in real unit cell a,b,c vectors basis</span>

<span class="sd">    .. note::</span>

<span class="sd">        v= ua+vb+wc (real unit cell a,b,c)</span>

<span class="sd">        [h,k,l] = fromrealframe_to_reciprocalframe([u,v,w], UB,Bmatrix)   i.e. ha*+kb*+lc*</span>

<span class="sd">        :math:`{\bf X_{recipr}}= B^{-1} P  {\bf X_{real}}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">computeDirectUnitCell_from_Bmatrix</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">)</span>
    <span class="n">invBmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invBmatrix</span><span class="p">,</span> <span class="n">P</span><span class="p">),</span> <span class="n">vector</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fromreciprocalframe_to_realframe</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert components of vector expressed in reciprocal unit cell basis vectors</span>
<span class="sd">    to direct (real) ones</span>

<span class="sd">    v= ha*+kb*+lc*</span>
<span class="sd">    v= fromreciprocalframe_to_realframe([h,k,l])  = [u,v,w]</span>

<span class="sd">    Xreal= P-1 * B* Xrecipr</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">computeDirectUnitCell_from_Bmatrix</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">)</span>
    <span class="n">invP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invP</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">),</span> <span class="n">vector</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">DirectUnitCellVectors_from_UB</span><span class="p">(</span><span class="n">UB</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns matrix whose columns are unit cell basis vector a,b,c in absolute Lauetools frame</span>

<span class="sd">    get a,b,c from  astar=UB Bmatrix (1 0 0)</span>
<span class="sd">                    bstar=UB Bmatrix (0 1 0)</span>
<span class="sd">                    cstar=UB Bmatrix (0 0 1)</span>
<span class="sd">    computeDirectUnitCell_from_Bmatrix(dot(UB,Bmatrix))</span>

<span class="sd">    ASSUMPTION: small deformation case where UB is considered as a pure rotation</span>
<span class="sd">    then dot(UB,computeDirectUnitCell_from_Bmatrix(Bmatrix))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">computeDirectUnitCell_from_Bmatrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">UB</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">))</span>


<div class="viewcode-block" id="VolumeCell"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.VolumeCell">[docs]</a><span class="k">def</span> <span class="nf">VolumeCell</span><span class="p">(</span><span class="n">latticeparameters</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes unit cell volume from lattice parameters (either real or reciprocal)</span>

<span class="sd">    :param latticeparameters: 6 lattice parameters</span>
<span class="sd">    :returns: scalar volume</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">latticeparameters</span>
    <span class="n">Alp</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">DEG</span>
    <span class="n">Bet</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">DEG</span>
    <span class="n">Gam</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">DEG</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Alp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Bet</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Gam</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Alp</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Bet</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Gam</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">matstarlab_to_matdirlab</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vec_in_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute the direct lattice matrix (a,b,c vectors) from the reciprocal matrix (a*,b*,c*)</span>

<span class="sd">    :param matstarlab: matrix of reciprocal basis vector a*,b*,c* in lab. frame</span>
<span class="sd">                    (1rst  column is made of components of a* vector in lab. frame bases)</span>

<span class="sd">    :param matdirlab:  matrix of direct (non reciprocal) basis vectors a,b,c in lab. frame</span>
<span class="sd">                    (1rst  column is made of components of a vector in lab. frame bases)</span>

<span class="sd">    :param vec_in_columns:  boolean, convention to express the 9 elements matrix in line (False) such as</span>
<span class="sd">                            first 3 elements correspond to the first column (when reshaped 3*3)</span>

<span class="sd">    :returns: matdirlab, reciprocal_lattice_parameters</span>

<span class="sd">    .. note::</span>

<span class="sd">        * lab frame is following;</span>
<span class="sd">        O. Robach&#39;s frame  y//ki, z towards CCD (in 2theta=90deg geometry), x=y^z</span>

<span class="sd">        * Lauetools (UBmat and B0 definition):</span>
<span class="sd">        x//ki, z towards CCD (in 2theta=90deg geometry), y=z^x</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[:]</span>

    <span class="c1"># if matstarlab is 9 elements array</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">vec_in_columns</span><span class="p">:</span>
            <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="o">.</span><span class="n">T</span>

    <span class="n">reciprocal_lattice_parameters</span> <span class="o">=</span> <span class="n">matrix_to_rlat</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="n">angles_in_deg</span><span class="p">)</span>
    <span class="c1"># print reciprocal_lattice_parameters</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">vol_cell</span><span class="p">(</span><span class="n">reciprocal_lattice_parameters</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="n">angles_in_deg</span><span class="p">)</span>

    <span class="n">astar1</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">bstar1</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cstar1</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">adir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">bstar1</span><span class="p">,</span> <span class="n">cstar1</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span>
    <span class="n">bdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cstar1</span><span class="p">,</span> <span class="n">astar1</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span>
    <span class="n">cdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">astar1</span><span class="p">,</span> <span class="n">bstar1</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span>

    <span class="n">matdirlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">adir</span><span class="p">,</span> <span class="n">bdir</span><span class="p">,</span> <span class="n">cdir</span><span class="p">))</span>

    <span class="c1"># print &quot; matdirlab =\n&quot;, matdirlab.round(decimals=6)</span>

    <span class="k">return</span> <span class="n">matdirlab</span><span class="p">,</span> <span class="n">reciprocal_lattice_parameters</span>


<div class="viewcode-block" id="matrix_to_rlat"><a class="viewcode-back" href="../../Simulation_Module.html#LaueTools.CrystalParameters.matrix_to_rlat">[docs]</a><span class="k">def</span> <span class="nf">matrix_to_rlat</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns RECIPROCAL lattice parameters of the unit cell a*,b*,c* in columns of `mat`</span>

<span class="sd">    :param mat: matrix where columns are respectively a*,b*,c* coordinates in orthonormal frame</span>

<span class="sd">    :returns: [a*,b*,c*, alpha*, beta*, gamma*] (angles are in degrees)</span>

<span class="sd">    .. note::</span>

<span class="sd">        Reciprocal lattice parameters are contained in UB matrix : q =  mat G*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>  <span class="c1"># A</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>  <span class="c1"># B</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))</span>  <span class="c1"># C</span>

    <span class="n">rlat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>  <span class="c1"># cos-1 (B,C)/(B,C)</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">angles_in_deg</span><span class="p">:</span>
        <span class="n">rlat</span> <span class="o">=</span> <span class="n">rlat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RAD</span><span class="p">,</span> <span class="n">RAD</span><span class="p">,</span> <span class="n">RAD</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">rlat</span></div>


<span class="k">def</span> <span class="nf">dlat_to_rlat</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">setvolume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes RECIPROCAL lattice parameters from DIRECT lattice parameters `dlat`</span>

<span class="sd">    :param dlat: [a,b,c, alpha, beta, gamma] angles are in degrees</span>
<span class="sd">    :param angles_in_deg: 1 when last three parameters are angle in degrees</span>
<span class="sd">    (then results angles are in degrees)</span>

<span class="sd">    :returns: [a*,b*,c*, alpha*, beta*, gamma*] angles are in degrees</span>

<span class="sd">    .. note::</span>

<span class="sd">        dlat stands for DIRECT (real space) lattice, rlat for RECIPROCAL lattice</span>

<span class="sd">    .. todo:: To remove setvolume</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">angles_in_deg</span><span class="p">:</span>
        <span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">DEG</span>
        <span class="c1"># convert deg into radian</span>

    <span class="c1"># Compute reciprocal lattice parameters. The convention used is that</span>
    <span class="c1"># a[i]*b[j] = d[ij], i.e. no 2PI&#39;s in reciprocal lattice.</span>

    <span class="c1"># compute volume of real lattice cell</span>

    <span class="c1">#     print &#39;dlat[:6]&#39;, dlat[:6]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">setvolume</span><span class="p">:</span>
        <span class="n">dvolume</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="k">elif</span> <span class="n">setvolume</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dvolume</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">setvolume</span> <span class="o">==</span> <span class="s2">&quot;a**3&quot;</span><span class="p">:</span>
        <span class="n">dvolume</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">setvolume</span> <span class="o">==</span> <span class="s2">&quot;b**3&quot;</span><span class="p">:</span>
        <span class="n">dvolume</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">setvolume</span> <span class="o">==</span> <span class="s2">&quot;c**3&quot;</span><span class="p">:</span>
        <span class="n">dvolume</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>

    <span class="c1"># compute reciprocal lattice parameters</span>

    <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">dvolume</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="n">dvolume</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="n">dvolume</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="n">rlat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">angles_in_deg</span><span class="p">:</span>
        <span class="n">rlat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">RAD</span>
        <span class="c1"># convert radians into degrees</span>

    <span class="k">return</span> <span class="n">rlat</span>


<span class="k">def</span> <span class="nf">vol_cell</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes volume of unit cell (direct space) defined from direct lattice parameters</span>
<span class="sd">     dlat=[a,b,c, alpha, beta, gamma]</span>
<span class="sd">    (lengthes in angstrom, angles are in degrees)</span>

<span class="sd">    Volume is in unit**3 of unit given by the first three elements</span>

<span class="sd">    .. note::</span>
<span class="sd">        from O Robach&#39;s scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">dlat</span><span class="p">[:]</span>

    <span class="k">if</span> <span class="n">angles_in_deg</span><span class="p">:</span>
        <span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">DEG</span>

    <span class="n">volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">angles_in_deg</span><span class="p">:</span>
        <span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">RAD</span>

    <span class="k">return</span> <span class="n">volume</span>


<span class="k">def</span> <span class="nf">dlat_to_dil</span><span class="p">(</span><span class="n">dlat_unstrained</span><span class="p">,</span> <span class="n">dlat_strained</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes hydrostatic expansion coefficient in direct space</span>
<span class="sd">    from two lattice parameters sets (strained and reference) in direct space</span>

<span class="sd">    .. todo:: check if dil formula -1 in inside or outsite the power 1/3??</span>

<span class="sd">    .. note::</span>
<span class="sd">        from O Robach&#39;s scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volu</span> <span class="o">=</span> <span class="n">vol_cell</span><span class="p">(</span><span class="n">dlat_unstrained</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="n">angles_in_deg</span><span class="p">)</span>
    <span class="n">vols</span> <span class="o">=</span> <span class="n">vol_cell</span><span class="p">(</span><span class="n">dlat_strained</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="n">angles_in_deg</span><span class="p">)</span>
    <span class="c1"># print &quot;cell volume : unstrained / strained &quot;, volu, vols</span>
    <span class="n">dil</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">vols</span> <span class="o">/</span> <span class="n">volu</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="c1"># print &quot;dilatation ((vols/volu)^(1/3) - 1 ) = &quot;, dil</span>
    <span class="k">return</span> <span class="n">dil</span>


<span class="k">def</span> <span class="nf">calc_epsp</span><span class="p">(</span><span class="n">dlat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From direct space lattice parameter dlat=[a,b,c, alpha, beta, gamma]</span>
<span class="sd">    (alpha, beta, gamma in DEGREES)</span>
<span class="sd">    calculates deviatoric strain from initially cubic lattice (a=b=c, alpha=beta=gamma=90)</span>
<span class="sd">    and from SMALL deformation</span>

<span class="sd">    .. note::</span>

<span class="sd">        from O Robach&#39;s scripts</span>

<span class="sd">    .. todo:: to be deleted since not general</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">epsp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlat</span><span class="p">)</span>

    <span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">DEG</span>

    <span class="n">meanlattice</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="n">epsp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">meanlattice</span><span class="p">)</span> <span class="o">/</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">epsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">meanlattice</span><span class="p">)</span> <span class="o">/</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">epsp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">meanlattice</span><span class="p">)</span> <span class="o">/</span> <span class="n">dlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">epsp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">epsp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">epsp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">dlat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># print &quot;deviatoric strain 11 22 33 -dalf 23, -dbet 13, -dgam 12 \n&quot;, epsp</span>
    <span class="k">return</span> <span class="n">epsp</span>


<span class="k">def</span> <span class="nf">strain_from_crystal_to_sample_frame2</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">UBmat</span><span class="p">,</span> <span class="n">sampletilt</span><span class="o">=</span><span class="mf">40.0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    qxyzLT= UB B0 q_a*b*c*</span>

<span class="sd">    if cubic , B0 is proportional to Id, then frame transfrom matrix is UBmat</span>

<span class="sd">    Normally pure rotational part of UBmat must be considered...It should be Ok for small deformation in UBmat</span>

<span class="sd">    qxyzLT=P q sample  (P = (cos40,0,-sin40),(0,1,0),(sin40,0,cos40))</span>

<span class="sd">    then:</span>

<span class="sd">    operator_sample= P-1 UB operator_crystal UB-1 P</span>

<span class="sd">    sampletilt in degree</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">matRot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">sampletilt</span><span class="p">)</span>
    <span class="c1">#    M = np.dot(np.linalg.inv(P), UBmat)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">UBmat</span><span class="p">)</span>  <span class="c1"># matrice unitaire : inverse = transposee</span>
    <span class="n">invM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">UBmat</span><span class="p">),</span> <span class="n">P</span><span class="p">)</span>

    <span class="n">strain_sampleframe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">invM</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">strain_sampleframe</span>


<span class="k">def</span> <span class="nf">strain_from_crystal_to_LaueToolsframe</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">UBmat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    qxyzLT= UB B0 q_a*b*c*</span>

<span class="sd">    if cubic , B0 is proportional to Id, then frame transfrom matrix is UBmat</span>

<span class="sd">    Normally pure rotational part of UBmat must be considered...It should be Ok for small deformation in UBmat</span>

<span class="sd">    operator_LT= UB operator_crystal UB-1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strain_LaueToolsframe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">UBmat</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">strain_LaueToolsframe</span>


<span class="k">def</span> <span class="nf">strain_from_crystal_to_sample_frame</span><span class="p">(</span>
    <span class="n">deviat_strain</span><span class="p">,</span> <span class="n">UBmat</span><span class="p">,</span> <span class="n">omega0</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span> <span class="n">LaueToolsFrame_for_UBmat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute deviatoric strain in sample frame from orientation matrix</span>

<span class="sd">    :param deviat_strain: symetric deviatoric strain tensor (matrix 3x3)</span>
<span class="sd">    :param UBmat: orientation matrix with strain</span>

<span class="sd">    :param LaueToolsFrame_for_UBmat: must be False if UBmat is the orientation matrix expressed in OR lab frame</span>

<span class="sd">    :param omega0: tilt angle of the sample surface with respect to the incoming beam  (in degrees)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LaueToolsFrame_for_UBmat</span><span class="p">:</span>
        <span class="c1"># from matstarlab in Odile&#39;s frame</span>
        <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">UBmat</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;strain_from_crystal_to_sample_frame function &quot;</span>
                <span class="s2">&quot;needs 3x3 orientation matrix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># from UB matrix in Lauetools frame</span>
        <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlabLaueTools_to_matstarlabOR</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UBmat</span><span class="p">),</span> <span class="n">returnMatrixInLine</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">matdirONDsample</span> <span class="o">=</span> <span class="n">matstarlab_to_matdirONDsample</span><span class="p">(</span>
        <span class="n">matstarlab</span><span class="p">,</span> <span class="n">omega0</span><span class="o">=</span><span class="n">omega0</span><span class="p">,</span> <span class="n">matrix_in_LaueToolsFrame</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">deviatoric_strain_sampleframe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">matdirONDsample</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">deviat_strain</span><span class="p">,</span> <span class="n">matdirONDsample</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deviatoric_strain_sampleframe</span>


<span class="k">def</span> <span class="nf">hydrostaticStrain</span><span class="p">(</span><span class="n">deviatoricStrain</span><span class="p">,</span> <span class="n">key_material</span><span class="p">,</span> <span class="n">UBmatrix</span><span class="p">,</span> <span class="n">assumption</span><span class="o">=</span><span class="s2">&quot;stresszz=0&quot;</span><span class="p">,</span>
                                                                        <span class="n">sampletilt</span><span class="o">=</span><span class="mf">40.0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes full strain &amp; stress from deviatoricStrain (voigt notation in crystal frame), material</span>
<span class="sd">    and mechanical assumtion</span>

<span class="sd">    C a*b*c* = (UB-1P)**2 C sample (P-1 UB)**2</span>
<span class="sd">    qxyzLT = P qsample</span>
<span class="sd">    qxyzLT=UB qcrystal(a*b*c*)</span>
<span class="sd">    stress xyzLT = P stress sample P-1</span>

<span class="sd">    sigma =C eps</span>
<span class="sd">    rank 2 = rank 4 rank 2</span>

<span class="sd">    voigt notation</span>
<span class="sd">    sigma = C eps</span>

<span class="sd">    (s11,s22,s33,s23,s13,s12)=C (eps11,eps22,eps33,2*eps23,2*eps13,2*eps12)</span>
<span class="sd">    with C = 6x6 &#39;matrix&#39;</span>

<span class="sd">    full strain = deviatoric_strain + hydrostatic_strain/3 * Identity</span>
<span class="sd">      eps =eps_dev+eps_h/3 * Idmatrix(3,3):</span>
<span class="sd">     (s11,s22,s33,s23,s13,s12)=C (eps_dev11+eps_h/3,</span>
<span class="sd">                                 eps_dev22+eps_h/3,</span>
<span class="sd">                                eps_dev33+eps_h/3,</span>
<span class="sd">                                 2*eps_dev23,</span>
<span class="sd">                                 2*eps_dev13,</span>
<span class="sd">                                 2*eps_dev12)</span>
<span class="sd">    to get  eps_h since</span>
<span class="sd">    mechanical assumption on sigmazz=0 corresponds to third component calcutation:</span>
<span class="sd">    scalar product of C[2] with eps =0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ELASTICITYMODULE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You need to install elasticity.py module!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">assumption</span> <span class="o">!=</span> <span class="s2">&quot;stresszz=0&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not yet implemented&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">symmetry</span> <span class="o">=</span> <span class="n">dict_Stiffness</span><span class="p">[</span><span class="n">key_material</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">symmetry</span> <span class="o">!=</span> <span class="s2">&quot;cubic&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not yet implemented&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># constant in crystal frame</span>
    <span class="n">c11</span><span class="p">,</span> <span class="n">c12</span><span class="p">,</span> <span class="n">c44</span> <span class="o">=</span> <span class="n">dict_Stiffness</span><span class="p">[</span><span class="n">key_material</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;c11, c12, c44&quot;</span><span class="p">,</span> <span class="n">c11</span><span class="p">,</span> <span class="n">c12</span><span class="p">,</span> <span class="n">c44</span><span class="p">)</span>

    <span class="c1"># Cmatrix = np.array( [ [c11, c12, c12, 0, 0, 0],</span>
    <span class="c1">#         [c12, c11, c12, 0, 0, 0],</span>
    <span class="c1">#         [c12, c12, c11, 0, 0, 0],</span>
    <span class="c1">#         [0, 0, 0, c44, 0, 0],</span>
    <span class="c1">#         [0, 0, 0, 0, c44, 0],</span>
    <span class="c1">#         [0, 0, 0, 0, 0, c44], ], dtype=np.float, )</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">matRot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">sampletilt</span><span class="p">)</span>

    <span class="n">transformmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">UBmatrix</span><span class="p">),</span> <span class="n">P</span><span class="p">)</span>
    <span class="c1">#     invtransformmatrix = np.linalg.inv(transformmatrix)</span>
    <span class="c1">#     transformmatrix = np.eye(3)</span>

    <span class="n">C_sampleframe</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">rotate_cubic_elastic_constants</span><span class="p">(</span><span class="n">c11</span><span class="p">,</span> <span class="n">c12</span><span class="p">,</span> <span class="n">c44</span><span class="p">,</span> <span class="n">transformmatrix</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;C_sampleframe&quot;</span><span class="p">,</span> <span class="n">C_sampleframe</span><span class="p">)</span>

    <span class="n">deviatoricStrain_sampleframe</span> <span class="o">=</span> <span class="n">strain_from_crystal_to_sample_frame2</span><span class="p">(</span>
        <span class="n">deviatoricStrain</span><span class="p">,</span> <span class="n">UBmatrix</span><span class="p">)</span>

    <span class="c1"># with UBmatrix=np.eye(3)</span>
    <span class="c1">#     deviatoricStrain_crystalframe=np.array([[ 0.00082635, -0.00076604, -0.00098481],</span>
    <span class="c1">#                                    [ 0.        , -0.001     ,  0.        ],</span>
    <span class="c1">#                                    [-0.00098481, -0.00064279,  0.00117365]])</span>

    <span class="c1">#     deviatoricStrain_sampleframe = np.array([[-0.001, -0.0, 0], [0.0, -0.001, 0], [0, 0, 0.002]])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deviatoricStrain_sampleframe&quot;</span><span class="p">,</span> <span class="n">deviatoricStrain_sampleframe</span><span class="p">)</span>

    <span class="c1"># use elasticity module instead</span>
    <span class="n">devstrain_voigt_sampleframe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">deviatoricStrain_sampleframe</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">Voigt_notation</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">*=</span> <span class="mf">2.0</span>
        <span class="n">devstrain_voigt_sampleframe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;devstrain_voigt_sampleframe&quot;</span><span class="p">,</span> <span class="n">devstrain_voigt_sampleframe</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; numerator&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">devstrain_voigt_sampleframe</span><span class="p">,</span> <span class="n">C_sampleframe</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;denominator&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_sampleframe</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;C_sampleframe[2]&quot;</span><span class="p">,</span> <span class="n">C_sampleframe</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># third row gives an equation where eps_hydro can be extracted</span>
    <span class="c1"># 0 = np.dot(devstrain_voigt,C_sampleframe[2])+eps_hydro/3.*np.sum(np.dot(devstrain_voigt[:3],C_sampleframe[2][3:]))</span>
    <span class="n">hydrostrain</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">devstrain_voigt_sampleframe</span><span class="p">,</span> <span class="n">C_sampleframe</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_sampleframe</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">3</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hydrostatic strain&quot;</span><span class="p">,</span> <span class="n">hydrostrain</span><span class="p">)</span>

    <span class="n">fullstrain_sampleframe</span> <span class="o">=</span> <span class="n">deviatoricStrain_sampleframe</span> <span class="o">+</span> <span class="n">hydrostrain</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">fullstrain_voigt_sampleframe</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">devstrain_voigt_sampleframe</span> <span class="o">+</span> <span class="n">hydrostrain</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

    <span class="n">fullstress_voigt_sampleframe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C_sampleframe</span><span class="p">,</span> <span class="n">fullstrain_voigt_sampleframe</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fullstress_voigt_sampleframe&quot;</span><span class="p">,</span> <span class="n">fullstress_voigt_sampleframe</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fullstress_voigt_sampleframe[2] stress normal to sample surface (must be 0)&quot;</span><span class="p">,</span>
        <span class="n">fullstress_voigt_sampleframe</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">fullstrain_sampleframe</span><span class="p">,</span>
        <span class="n">fullstress_voigt_sampleframe</span><span class="p">,</span>
        <span class="n">hydrostrain</span><span class="p">,</span>
        <span class="n">deviatoricStrain_sampleframe</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matstarlab_to_matstarlabOND</span><span class="p">(</span><span class="n">matstarlab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">matLT3x3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># OR</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orthonormalisation of matrix with to a*,b*,c* as columns</span>

<span class="sd">    .. note::</span>

<span class="sd">        from O Robach&#39;s scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;entering CP.matstarlab_to_matstarlabOND&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matstarlab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matstarlab = &quot;</span><span class="p">,</span> <span class="n">matstarlab</span><span class="p">)</span>
        <span class="n">astar1</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">bstar1</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="c1"># cstar1 = matstarlab[6:]</span>

    <span class="k">elif</span> <span class="n">matLT3x3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matLT3x3 = &quot;</span><span class="p">,</span> <span class="n">matLT3x3</span><span class="p">)</span>
        <span class="n">astar1</span> <span class="o">=</span> <span class="n">matLT3x3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">bstar1</span> <span class="o">=</span> <span class="n">matLT3x3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># cstar1 = matLT3x3[:, 2]</span>

    <span class="n">astar0</span> <span class="o">=</span> <span class="n">astar1</span> <span class="o">/</span> <span class="n">GT</span><span class="o">.</span><span class="n">norme_vec</span><span class="p">(</span><span class="n">astar1</span><span class="p">)</span>
    <span class="n">cstar0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">astar0</span><span class="p">,</span> <span class="n">bstar1</span><span class="p">)</span>
    <span class="n">cstar0</span> <span class="o">=</span> <span class="n">cstar0</span> <span class="o">/</span> <span class="n">GT</span><span class="o">.</span><span class="n">norme_vec</span><span class="p">(</span><span class="n">cstar0</span><span class="p">)</span>
    <span class="n">bstar0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cstar0</span><span class="p">,</span> <span class="n">astar0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">matstarlab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">matstarlabOND</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">astar0</span><span class="p">,</span> <span class="n">bstar0</span><span class="p">,</span> <span class="n">cstar0</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exiting CP.matstarlab_to_matstarlabOND&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matstarlabOND</span>
    <span class="k">elif</span> <span class="n">matLT3x3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">matLT3x3OND</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">astar0</span><span class="p">,</span> <span class="n">bstar0</span><span class="p">,</span> <span class="n">cstar0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matLT3x3OND = &quot;</span><span class="p">,</span> <span class="n">matLT3x3OND</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exiting CP.matstarlab_to_matstarlabOND&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matLT3x3OND</span>


<span class="k">def</span> <span class="nf">matstarlab_to_matdirONDsample</span><span class="p">(</span>
    <span class="n">matstarlab</span><span class="p">,</span> <span class="n">omega0</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span> <span class="n">matrix_in_LaueToolsFrame</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return matrix whose columns are basis vectors of frame OND related to</span>
<span class="sd">    direct crystal expressed in sample frame basis vectors</span>

<span class="sd">    matdirONDsample[:,0]   (ie 1rst column) : 3 components of vector a of OND related direct crystal</span>
<span class="sd">    in sample frame basis</span>

<span class="sd">    matstarlab   :   matrix with columns expressing components of a*,b*,c* in laboratory frame</span>
<span class="sd">                            (UBmat expressed in OR lab. frame)</span>

<span class="sd">    .. note::</span>

<span class="sd">        from O Robach&#39;s scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># uc unit cell</span>
    <span class="c1"># dir direct</span>
    <span class="c1"># uc_dir_OND : cartesian frame obtained by orthonormalizing direct unit cell</span>

    <span class="n">matdirlab</span><span class="p">,</span> <span class="n">rlat</span> <span class="o">=</span> <span class="n">matstarlab_to_matdirlab</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">latticeparameters</span> <span class="o">=</span> <span class="n">dlat_to_rlat</span><span class="p">(</span><span class="n">rlat</span><span class="p">,</span> <span class="n">angles_in_deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># dir_bmatrix = uc_dir on uc_dir_OND</span>

    <span class="c1">#     dir_bmatrix = dlat_to_Bstar(rlat)</span>
    <span class="n">dir_bmatrix</span> <span class="o">=</span> <span class="n">calc_B_RR</span><span class="p">(</span><span class="n">latticeparameters</span><span class="p">,</span> <span class="n">directspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># matdirONDlab = uc_dir_OND on lab</span>
    <span class="c1"># orientation matrix of the OND frame deduced from a,b,c (direct lattice vectors)</span>
    <span class="n">matdirONDlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matdirlab</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">dir_bmatrix</span><span class="p">))</span>

    <span class="c1"># matrot:</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">omega0</span> <span class="o">*</span> <span class="n">DEG</span>
    <span class="n">cw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">sw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="c1"># matrix from lab to sample frame</span>
    <span class="c1"># each column of matrot is composed of</span>
    <span class="c1"># components of one lab basis vector in the sample frame basis vectors</span>
    <span class="c1"># Xsample = matrot.Xlab</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix_in_LaueToolsFrame</span><span class="p">:</span>
        <span class="c1"># OR lab frame</span>
        <span class="c1"># rotation de -omega autour de l&#39;axe x pour repasser dans Rsample</span>
        <span class="n">matrot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cw</span><span class="p">,</span> <span class="n">sw</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">sw</span><span class="p">,</span> <span class="n">cw</span><span class="p">]])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># LAuetools lab frame</span>
        <span class="n">matrot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cw</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">sw</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">sw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cw</span><span class="p">]])</span>

    <span class="c1"># matdirONDsample = uc_dir_OND on sample</span>
    <span class="c1"># rsample = matdirONDsample * ruc_dir_OND</span>
    <span class="c1"># orientation of the OND frame related to a,b,c (direct lattice vectors)</span>
    <span class="c1"># 1rst column is components of vector basis &#39;a&#39; of OND frame related to</span>
    <span class="c1"># crystal (direct space) expressed in sample frame</span>
    <span class="n">matdirONDsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrot</span><span class="p">,</span> <span class="n">matdirONDlab</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matdirONDsample</span>


<span class="k">def</span> <span class="nf">directlatticeparameters_fromBmatrix</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    computes direct space lattice parameters from Bmatrix (in reciprocal space)</span>

<span class="sd">    :param Bmatrix: Bmatrix  columns are a*,b*,c* expressed in lauetools frame</span>
<span class="sd">    :type Bmatrix: 3x3 Matrix</span>

<span class="sd">    :returns: lattice parameters   [a,b,c,alpha,beta,gamma]</span>

<span class="sd">    .. todo:: To be merged with functions above</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lattice_parameter_reciprocal</span> <span class="o">=</span> <span class="n">matrix_to_rlat</span><span class="p">(</span><span class="n">Bmatrix</span><span class="p">)</span>
    <span class="n">lattice_parameter_direct</span> <span class="o">=</span> <span class="n">dlat_to_rlat</span><span class="p">(</span><span class="n">lattice_parameter_reciprocal</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lattice_parameter_direct</span>


<span class="k">def</span> <span class="nf">matstarlabLaueTools_to_matstarlabOR</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">returnMatrixInLine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert matrix from lauetools frame: ki//x, z towards CCD (top), y = z^x</span>
<span class="sd">                    to ORobach (or equivalent XMAS)&#39;s frame: ki//y, z towards CCD (top), y = z^x</span>

<span class="sd">    convert the so called UBmat to matstarlab</span>
<span class="sd">    (matstarlab stands for &#39;matrix of reciprocal unit cell basis vectors in lab. frame&#39;)</span>

<span class="sd">    see the reciprocal function: matstarlabOR_to_matstarlabLaueTools</span>

<span class="sd">    WARNING: convention for writing in line:</span>
<span class="sd">    mat = [a0,a1,a2,a3,a4,a5,a6,a7,a8,a9]</span>
<span class="sd">    in 3*3 representation: [[a0,a3,a6],[a1,a4,a7],[a2,a5,a8]] !!</span>
<span class="sd">    ie a0,a1,a2 forms the 1rst column!</span>
<span class="sd">    so take care of transpose the natural reshaped matrix</span>
<span class="sd">    mat3x3 = mat.reshape((3,3)).T</span>

<span class="sd">    warning : here input UBmat should include B0  # OR</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">UBmat</span>

    <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="o">-</span><span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="o">-</span><span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span> <span class="o">/</span> <span class="n">GT</span><span class="o">.</span><span class="n">norme_vec</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">returnMatrixInLine</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">matstarlab</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">matstarlab</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>


<span class="c1"># X_OR = M. X_LT</span>
<span class="n">M_LT_to_OR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="c1"># inverse operator</span>
<span class="n">M_OR_to_LT</span> <span class="o">=</span> <span class="n">M_LT_to_OR</span><span class="o">.</span><span class="n">T</span>


<span class="k">def</span> <span class="nf">from_Lauetools_to_ORlabframe</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M_LT_to_OR</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">from_ORlabframe_to_Lauetools</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M_OR_to_LT</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matstarlabOR_to_matstarlabLaueTools</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">,</span> <span class="n">vec_in_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reciprocal function of matstarlabLaueTools_to_matstarlabOR</span>
<span class="sd">    see corresponding doc</span>

<span class="sd">    warning : here resulting UBmat includes B0   # OR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="p">[:]</span>

    <span class="c1"># if matstarlab is 9 elements array</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">vec_in_columns</span><span class="p">:</span>
            <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlab</span><span class="o">.</span><span class="n">T</span>

    <span class="c1">#     mm = matstarlab  # line convention</span>
    <span class="c1">#</span>
    <span class="c1">#     UBmat = np.array([[mm[1], mm[4], mm[7]],</span>
    <span class="c1">#                     [-mm[0], -mm[3], -mm[6]],</span>
    <span class="c1">#                     [mm[2], mm[5], mm[8]]])</span>

    <span class="k">return</span> <span class="n">from_ORlabframe_to_Lauetools</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matstarlab_to_matstarsample3x3</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 40.</span>
                        <span class="n">mat_from_lab_to_sample_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                                                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.766044443118978</span><span class="p">,</span> <span class="mf">0.642787609686539</span><span class="p">],</span>
                                                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.642787609686539</span><span class="p">,</span> <span class="mf">0.766044443118978</span><span class="p">]])):</span>
    <span class="n">matstarlab3x3</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">matline_to_mat3x3</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">omega</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mat_from_lab_to_sample_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># deprecated - only for retrocompatibility</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">DEG</span>
        <span class="c1"># rotation de -omega autour de l&#39;axe x pour repasser dans Rsample</span>
        <span class="n">mat_from_lab_to_sample_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                                                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">)],</span>
                                                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">)]])</span>

    <span class="n">matstarsample3x3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_from_lab_to_sample_frame</span><span class="p">,</span> <span class="n">matstarlab3x3</span><span class="p">)</span>

    <span class="c1"># print  &quot;matstarsample3x3 =\n&quot; , matstarsample3x3.round(decimals=6)</span>
    <span class="k">return</span> <span class="n">matstarsample3x3</span>


<span class="k">def</span> <span class="nf">matrix_to_HKLs_along_xyz_sample_and_along_xyz_lab</span><span class="p">(</span><span class="n">matstarlab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># OR</span>
                                                    <span class="n">UBmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># LT , UBB0 ici</span>
                                                    <span class="n">omega</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 40. was MG.PAR.omega_sample_frame,</span>
                                                    <span class="n">mat_from_lab_to_sample_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">results_in_OR_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">results_in_LT_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">sampletilt</span><span class="o">=</span><span class="mf">40.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute HKLs which are parallel to xyz axis of sample frame and lab frame.</span>

<span class="sd">    One of the two optional arguments (matstarlab or UBmat) must be input.</span>

<span class="sd">    :param matstarlab: ORs matrix, defaults to None</span>
<span class="sd">    :type matstarlab: list or array (3x3), optional</span>
<span class="sd">    :param UBmat: UB.B0 matrix , defaults to None</span>
<span class="sd">    :type UBmat: list or array (3x3), optional</span>
<span class="sd">    :param omega: tilt of sample surface, defaults to None</span>
<span class="sd">    :type omega: scalar, optional</span>
<span class="sd">    :param mat_from_lab_to_sample_frame: [description], defaults to None</span>
<span class="sd">    :type mat_from_lab_to_sample_frame: [type], optional</span>
<span class="sd">    :param results_in_OR_frames: [description], defaults to 1</span>
<span class="sd">    :type results_in_OR_frames: int, optional</span>
<span class="sd">    :param results_in_LT_frames: [description], defaults to 0</span>
<span class="sd">    :type results_in_LT_frames: int, optional</span>
<span class="sd">    :param sampletilt: [description], defaults to 40.0</span>
<span class="sd">    :type sampletilt: float, optional</span>
<span class="sd">    :return: [description]</span>
<span class="sd">    :rtype: [type]</span>

<span class="sd">    .. warning::</span>
<span class="sd">        UBmat stands for UBB0  (i.e. UB times B0)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">UBmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">matstarlab</span> <span class="o">=</span> <span class="n">matstarlabLaueTools_to_matstarlabOR</span><span class="p">(</span><span class="n">UBmat</span><span class="p">,</span> <span class="n">returnMatrixInLine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matstarlab = &quot;</span><span class="p">,</span> <span class="n">matstarlab</span><span class="p">)</span>

    <span class="n">matstarlab3x3</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">matline_to_mat3x3</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">results_in_OR_frames</span><span class="p">:</span>
        <span class="n">str_end</span> <span class="o">=</span> <span class="s2">&quot;_OR&quot;</span>
    <span class="k">elif</span> <span class="n">results_in_LT_frames</span><span class="p">:</span>
        <span class="n">str_end</span> <span class="o">=</span> <span class="s2">&quot;_LT&quot;</span>

    <span class="n">HKL_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">strlist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
    <span class="n">list_HKL_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
        <span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;HKL&quot;</span> <span class="o">+</span> <span class="n">strlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_lab&quot;</span> <span class="o">+</span> <span class="n">str_end</span>
        <span class="n">list_HKL_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
        <span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;HKL&quot;</span> <span class="o">+</span> <span class="n">strlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_sample&quot;</span> <span class="o">+</span> <span class="n">str_end</span>
        <span class="n">list_HKL_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">results_in_OR_frames</span><span class="p">:</span>

        <span class="n">matstarsample3x3</span> <span class="o">=</span> <span class="n">matstarlab_to_matstarsample3x3</span><span class="p">(</span><span class="n">matstarlab</span><span class="p">,</span>
                                        <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span>
                                        <span class="n">mat_from_lab_to_sample_frame</span><span class="o">=</span><span class="n">mat_from_lab_to_sample_frame</span><span class="p">)</span>

        <span class="n">mat3</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">matstarlab3x3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
            <span class="n">HKL_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mat3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">mat2</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">matstarsample3x3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
            <span class="n">HKL_xyz</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mat2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">results_in_LT_frames</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">UBmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">UBmat</span> <span class="o">=</span> <span class="n">from_ORlabframe_to_Lauetools</span><span class="p">(</span><span class="n">matstarlab3x3</span><span class="p">)</span>
        <span class="c1">#            UBmat_sample =  CP.from_ORlabframe_to_Lauetools(matstarsample3x3) # variante 1</span>
        <span class="n">PP</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">matRot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">sampletilt</span><span class="p">)</span>
        <span class="n">UBmat_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PP</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">UBmat</span><span class="p">)</span>  <span class="c1"># variante 2</span>

        <span class="n">mat3</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">UBmat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
            <span class="n">HKL_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mat3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">mat2</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">UBmat_sample</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
            <span class="n">HKL_xyz</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mat2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HKL coordinates of lab and sample frame axes :&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">list_HKL_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">HKL_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">list_HKL_names</span><span class="p">,</span> <span class="n">HKL_xyz</span><span class="p">)</span>


<span class="c1"># ---------------------    Metric tensor</span>
<span class="k">def</span> <span class="nf">ComputeMetricTensor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    computes metric tensor G or G* from lattice parameters</span>
<span class="sd">    (either direct or reciprocal * ones)</span>

<span class="sd">    :param a,b,c,alpha,beta,gamma: lattice parameters (angles in degrees)</span>

<span class="sd">    :returns: 3x3 metric tensor</span>

<span class="sd">    .. todo:: Clarify G or G*</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">DEG</span>
    <span class="n">Beta</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">DEG</span>
    <span class="n">Gamma</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">DEG</span>

    <span class="n">row1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Gamma</span><span class="p">),</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Beta</span><span class="p">)])</span>
    <span class="n">row2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Gamma</span><span class="p">),</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Alpha</span><span class="p">)])</span>
    <span class="n">row3</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Beta</span><span class="p">),</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Alpha</span><span class="p">),</span> <span class="n">c</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">row1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row3</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">Gstar_from_directlatticeparams</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    G  = G*-1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">inv</span><span class="p">(</span><span class="n">ComputeMetricTensor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">DSpacing</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">Gstar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    computes dspacing, or interatomic distance between lattice plane),</span>
<span class="sd">    or d(hkl)  = 1/d(hkl)* in unit of 1/length in sqrt(Gstar)</span>

<span class="sd">    :param HKL: [H,K,L]</span>
<span class="sd">    :param Gstar: 3*3 matrix corresponding to reciprocal metric tensor of unit cell</span>
<span class="sd">                    (use Gstar_from_directlatticeparams())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HKLr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL</span><span class="p">)</span>
    <span class="n">dstar_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">HKLr</span><span class="p">,</span> <span class="n">Gstar</span><span class="p">),</span> <span class="n">HKLr</span><span class="p">)</span>
    <span class="n">dstar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dstar_square</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dstar</span>


<span class="k">def</span> <span class="nf">Gnorm</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span> <span class="n">Gstar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute norm of G = [H,K,L] = d(hkl)* in unit of length in sqrt(Gstar)</span>

<span class="sd">    inputs:</span>
<span class="sd">    HKL            :  [H,K,L]</span>
<span class="sd">    Gstar            : 3*3 matrix corresponding to reciprocal metric tensor of unit cell</span>
<span class="sd">                    (use Gstar_from_directlatticeparams())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HKLr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL</span><span class="p">)</span>
    <span class="n">dstar_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">HKLr</span><span class="p">,</span> <span class="n">Gstar</span><span class="p">),</span> <span class="n">HKLr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dstar_square</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">strain_from_metric_difference</span><span class="p">(</span><span class="n">Ginit</span><span class="p">,</span> <span class="n">Gfinal</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    does not seem to work ...</span>
<span class="sd">    TODO to repair?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Gfinal</span> <span class="o">-</span> <span class="n">Ginit</span><span class="p">)</span>


<span class="c1"># ---- S. Tardif Part   copy from dhkl module  -----------</span>
<span class="kn">from</span> <span class="nn">numpy.linalg.linalg</span> <span class="k">import</span> <span class="n">norm</span>

<span class="c1"># import xray_tools as xrt</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">boa  means  b over a!!!!</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">S11p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">coa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">S22p</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">coa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">S33p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">S23p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boa</span> <span class="o">*</span> <span class="n">coa</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">S13p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">coa</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">S12p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boa</span> <span class="o">*</span> <span class="n">coa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">V2p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">boa</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">coa</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">fhkl</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">V2p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">S11p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="n">S22p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="n">S33p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">S23p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">l</span>
            <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">S13p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="n">h</span>
            <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">S12p</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">k</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">dhkl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return lattice spacing in the unit of a</span>

<span class="sd">    a,b,c must have the same unit</span>
<span class="sd">    alpha, beta, gamma   in radians</span>
<span class="sd">    h,k,l Miller indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boa</span><span class="p">,</span> <span class="n">coa</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="n">a</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fhkl</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">E2L</span><span class="p">(</span><span class="n">energy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    energy (ev) to wavelength in meter !!!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">12398.0</span> <span class="o">/</span> <span class="n">energy</span> <span class="o">*</span> <span class="mf">1e-10</span>


<span class="k">def</span> <span class="nf">L2E</span><span class="p">(</span><span class="n">wavel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     wavelength in meter to energy (ev)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">12398.0</span> <span class="o">/</span> <span class="n">wavel</span> <span class="o">*</span> <span class="mf">1e10</span>


<span class="k">def</span> <span class="nf">calculate_a</span><span class="p">(</span><span class="n">fitfile</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute lattice parameter from lattice spacing measured from energy for hkl reflection</span>
<span class="sd">    and deviatoric strain</span>

<span class="sd">    :param fitfile:  fitfile object</span>
<span class="sd">    :param energy: energy  in eV</span>

<span class="sd">    :returns: scalar a</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculate_a function in CrystalParameters&quot;</span><span class="p">)</span>
    <span class="c1"># b over a</span>
    <span class="n">boa</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">boa</span>
    <span class="c1"># c over a</span>
    <span class="n">coa</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">coa</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="c1"># reciprocal space basis vectors lengthes</span>
    <span class="n">astar</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">astar_prime</span>
    <span class="n">bstar</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">bstar_prime</span>
    <span class="n">cstar</span> <span class="o">=</span> <span class="n">fitfile</span><span class="o">.</span><span class="n">cstar_prime</span>
    <span class="c1">#  qxoverq = (h * astar + k * bstar + l * cstar)[0] / norm((h * astar + k * bstar + l * cstar))</span>
    <span class="c1"># Bragg angle</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;astar,bstar,cstar&quot;</span><span class="p">,</span> <span class="n">astar</span><span class="p">,</span> <span class="n">bstar</span><span class="p">,</span> <span class="n">cstar</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">norm</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar</span><span class="p">)))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;theta in rad&quot;</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;theta in degree&quot;</span><span class="p">,</span> <span class="n">theta</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">180.0</span><span class="p">)</span>
    <span class="n">normG</span> <span class="o">=</span> <span class="n">norm</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;normG par norm linalg&quot;</span><span class="p">,</span> <span class="n">normG</span><span class="p">)</span>
    <span class="n">normGclassic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;normGclassic&quot;</span><span class="p">,</span> <span class="n">normGclassic</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">E2L</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fhkl</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
        <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
    <span class="c1">#     a = E2L(energy) * np.sqrt(fhkl(boa, coa, alpha, beta, gamma, h, k, l)) / 2. / qxoverq</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">scale_fitfile</span><span class="p">(</span><span class="n">fitfileObject</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">denergy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">a0</span><span class="o">=</span><span class="mf">5.6575</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute hydrostatic strain and full strain tensor</span>

<span class="sd">    from:</span>
<span class="sd">    fitfileObject</span>

<span class="sd">    energy in eV</span>
<span class="sd">    error on energy in eV</span>
<span class="sd">    h,k,l Miller indices</span>
<span class="sd">    a0  lattice parameter in Angstrom (10-10 m or 0.1 nm)</span>

<span class="sd">    Do:</span>
<span class="sd">    set fitfileObjectObject strain attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1e10</span> <span class="o">*</span> <span class="n">calculate_a</span><span class="p">(</span><span class="n">fitfileObject</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculated lattice parameter (Angstr)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unstrained lattice parameter (Angstr)&quot;</span><span class="p">,</span> <span class="n">a0</span><span class="p">)</span>

    <span class="c1"># calculate the hydrostatic strain:</span>
    <span class="n">fitfileObject</span><span class="o">.</span><span class="n">hydrostatic_measured</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a0</span><span class="p">)</span> <span class="o">/</span> <span class="n">a0</span> <span class="o">-</span> <span class="n">fitfileObject</span><span class="o">.</span><span class="n">deviatoric</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">fitfileObject</span><span class="o">.</span><span class="n">full_strain_measured</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">fitfileObject</span><span class="o">.</span><span class="n">deviatoric</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">fitfileObject</span><span class="o">.</span><span class="n">hydrostatic_measured</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">denergy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a_lower</span> <span class="o">=</span> <span class="mf">1e10</span> <span class="o">*</span> <span class="n">calculate_a</span><span class="p">(</span><span class="n">fitfileObject</span><span class="p">,</span> <span class="n">energy</span> <span class="o">+</span> <span class="n">denergy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">hydrostatic_lower</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="n">a_lower</span> <span class="o">-</span> <span class="n">a0</span><span class="p">)</span> <span class="o">/</span> <span class="n">a0</span> <span class="o">-</span> <span class="n">fitfileObject</span><span class="o">.</span><span class="n">deviatoric</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">a_upper</span> <span class="o">=</span> <span class="mf">1e10</span> <span class="o">*</span> <span class="n">calculate_a</span><span class="p">(</span><span class="n">fitfileObject</span><span class="p">,</span> <span class="n">energy</span> <span class="o">-</span> <span class="n">denergy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">hydrostatic_upper</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="n">a_upper</span> <span class="o">-</span> <span class="n">a0</span><span class="p">)</span> <span class="o">/</span> <span class="n">a0</span> <span class="o">-</span> <span class="n">fitfileObject</span><span class="o">.</span><span class="n">deviatoric</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">fitfileObject</span><span class="o">.</span><span class="n">hydrostatic_measured_error</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">fitfileObject</span><span class="o">.</span><span class="n">hydrostatic_measured</span> <span class="o">-</span> <span class="n">hydrostatic_lower</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fitfileObject</span><span class="o">.</span><span class="n">hydrostatic_measured</span> <span class="o">-</span> <span class="n">hydrostatic_upper</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">fitfileObject</span><span class="o">.</span><span class="n">full_strain_measured_error</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">fitfileObject</span><span class="o">.</span><span class="n">hydrostatic_measured_error</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">calculate_from_UB</span><span class="p">(</span><span class="n">UBB0</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="n">astar_prime</span> <span class="o">=</span> <span class="n">UBB0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">bstar_prime</span> <span class="o">=</span> <span class="n">UBB0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cstar_prime</span> <span class="o">=</span> <span class="n">UBB0</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">a_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">bstar_prime</span><span class="p">,</span> <span class="n">cstar_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">astar_prime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">bstar_prime</span><span class="p">,</span> <span class="n">cstar_prime</span><span class="p">))</span>
    <span class="n">b_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cstar_prime</span><span class="p">,</span> <span class="n">astar_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">bstar_prime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cstar_prime</span><span class="p">,</span> <span class="n">astar_prime</span><span class="p">))</span>
    <span class="n">c_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">astar_prime</span><span class="p">,</span> <span class="n">bstar_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">cstar_prime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">astar_prime</span><span class="p">,</span> <span class="n">bstar_prime</span><span class="p">))</span>

    <span class="n">boa</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">b_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">)</span>
    <span class="n">coa</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">c_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b_prime</span><span class="p">,</span> <span class="n">c_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">b_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">c_prime</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_prime</span><span class="p">,</span> <span class="n">a_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">c_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">))</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_prime</span><span class="p">,</span> <span class="n">b_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">b_prime</span><span class="p">))</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar_prime</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar_prime</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">norm</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar_prime</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar_prime</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar_prime</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">E2L</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fhkl</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">calculate_energy_from_UB</span><span class="p">(</span><span class="n">UBB0</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate energy from UB.B0 matrix, reference a0 direct lattice parameter length</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">astar_prime</span> <span class="o">=</span> <span class="n">UBB0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">bstar_prime</span> <span class="o">=</span> <span class="n">UBB0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cstar_prime</span> <span class="o">=</span> <span class="n">UBB0</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">a_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">bstar_prime</span><span class="p">,</span> <span class="n">cstar_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">astar_prime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">bstar_prime</span><span class="p">,</span> <span class="n">cstar_prime</span><span class="p">))</span>
    <span class="n">b_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cstar_prime</span><span class="p">,</span> <span class="n">astar_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">bstar_prime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cstar_prime</span><span class="p">,</span> <span class="n">astar_prime</span><span class="p">))</span>
    <span class="n">c_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">astar_prime</span><span class="p">,</span> <span class="n">bstar_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">cstar_prime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">astar_prime</span><span class="p">,</span> <span class="n">bstar_prime</span><span class="p">))</span>

    <span class="n">boa</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">b_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">)</span>
    <span class="n">coa</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">c_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b_prime</span><span class="p">,</span> <span class="n">c_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">b_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">c_prime</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_prime</span><span class="p">,</span> <span class="n">a_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">c_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">))</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_prime</span><span class="p">,</span> <span class="n">b_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">a_prime</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">b_prime</span><span class="p">))</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar_prime</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar_prime</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">norm</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">astar_prime</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">bstar_prime</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="n">cstar_prime</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">L2E</span><span class="p">(</span><span class="n">a0</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fhkl</span><span class="p">(</span><span class="n">boa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">energy</span>


<span class="k">def</span> <span class="nf">scale_UB</span><span class="p">(</span><span class="n">UBB0</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">a0</span><span class="o">=</span><span class="mf">5.6575</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1e10</span> <span class="o">*</span> <span class="n">calculate_a</span><span class="p">(</span><span class="n">UBB0</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="c1"># calculate the hydrostatic strain:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a0</span><span class="p">)</span> <span class="o">/</span> <span class="n">a0</span>

<span class="k">def</span> <span class="nf">norme</span><span class="p">(</span><span class="n">vec1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    computes norm of a single vector</span>

<span class="sd">    .. note::</span>
<span class="sd">        from O Robach</span>

<span class="sd">    .. todo:: use better generaltools module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nvec</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, J.S. Micha, O. Robach., S. Tardif

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>