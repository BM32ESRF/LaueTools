

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LaueTools.readmccd &mdash; LaueTools  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> LaueTools
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getStarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GUIs.html">Graphical User Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LaueToolsModules.html">LaueTools Modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LaueTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>LaueTools.readmccd</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for LaueTools.readmccd</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">readmccd module is made for reading data contained in binary image file</span>
<span class="sd">fully or partially.</span>
<span class="sd">It can process a peak or blob search by various methods</span>
<span class="sd">and refine the peak by a gaussian or lorentzian 2D model</span>

<span class="sd">More tools can be found in LaueTools package at sourceforge.net and gitlab.esrf.fr</span>
<span class="sd">March 2020</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Jean-Sebastien Micha, CRG-IF BM32 @ ESRF&quot;</span>

<span class="c1"># built-in modules</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">ttt</span>

<span class="kn">import</span> <span class="nn">configparser</span> <span class="k">as</span> <span class="nn">CONF</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># lauetools modules</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">fit2Dintensity</span> <span class="k">as</span> <span class="n">fit2d</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">fit2Dintensity_Lorentz</span> <span class="k">as</span> <span class="n">fit2d_l</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">generaltools</span> <span class="k">as</span> <span class="n">GT</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">IOLaueTools</span> <span class="k">as</span> <span class="n">IOLT</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">IOimagefile</span> <span class="k">as</span> <span class="n">IOimage</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">dict_LaueTools</span> <span class="k">as</span> <span class="n">DictLT</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">imageprocessing</span> <span class="k">as</span> <span class="n">ImProc</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fit2Dintensity</span> <span class="k">as</span> <span class="nn">fit2d</span>
    <span class="kn">import</span> <span class="nn">fit2Dintensity_Lorentz</span> <span class="k">as</span> <span class="nn">fit2d_l</span>
    <span class="kn">import</span> <span class="nn">generaltools</span> <span class="k">as</span> <span class="nn">GT</span>
    <span class="kn">import</span> <span class="nn">IOLaueTools</span> <span class="k">as</span> <span class="nn">IOLT</span>
    <span class="kn">import</span> <span class="nn">IOimagefile</span> <span class="k">as</span> <span class="nn">IOimage</span>
    <span class="kn">import</span> <span class="nn">dict_LaueTools</span> <span class="k">as</span> <span class="nn">DictLT</span>
    <span class="kn">import</span> <span class="nn">imageprocessing</span> <span class="k">as</span> <span class="nn">ImProc</span>

<span class="n">listfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>

<span class="c1"># Default dictionary peak search parameters:</span>

<span class="n">PEAKSEARCHDICT_Convolve</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PixelNearRadius&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="s2">&quot;thresholdConvolve&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                        <span class="s2">&quot;IntensityThreshold&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="s2">&quot;removeedge&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;local_maxima_search_method&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;boxsize&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                        <span class="s2">&quot;position_definition&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;fit_peaks_gaussian&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;xtol&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
                        <span class="s2">&quot;FitPixelDev&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                        <span class="s2">&quot;return_histo&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;write_execution_time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">:</span> <span class="s2">&quot;auto_background&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;NumberMaxofFits&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}</span>
<span class="c1"># &#39;MaxPeakSize&#39;:3.0,</span>
<span class="c1"># &#39;MinPeakSize&#39;:0.01</span>
<span class="c1"># }</span>

<span class="n">IOimagefuncs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Add_Images&#39;</span><span class="p">,</span> <span class="s1">&#39;Add_Images2&#39;</span><span class="p">,</span> <span class="s1">&#39;SumImages&#39;</span><span class="p">,</span> <span class="s1">&#39;getIndex_fromfilename&#39;</span><span class="p">,</span> <span class="s1">&#39;get_imagesize&#39;</span><span class="p">,</span>
<span class="s1">&#39;getpixelValue&#39;</span><span class="p">,</span> <span class="s1">&#39;getwildcardstring&#39;</span><span class="p">,</span> <span class="s1">&#39;libtiff_ctypes&#39;</span><span class="p">,</span> <span class="s1">&#39;listfile&#39;</span><span class="p">,</span> <span class="s1">&#39;readCCDimage&#39;</span><span class="p">,</span> <span class="s1">&#39;read_header_marccd&#39;</span><span class="p">,</span>
 <span class="s1">&#39;read_header_marccd2&#39;</span><span class="p">,</span> <span class="s1">&#39;read_header_scmos&#39;</span><span class="p">,</span> <span class="s1">&#39;read_motorsposition_fromheader&#39;</span><span class="p">,</span> <span class="s1">&#39;readheader&#39;</span><span class="p">,</span> <span class="s1">&#39;readoneimage&#39;</span><span class="p">,</span> <span class="s1">&#39;readoneimage_band&#39;</span><span class="p">,</span> <span class="s1">&#39;readoneimage_crop&#39;</span><span class="p">,</span> <span class="s1">&#39;readoneimage_crop_fast&#39;</span><span class="p">,</span> <span class="s1">&#39;readoneimage_full&#39;</span><span class="p">,</span> <span class="s1">&#39;readoneimage_manycrops&#39;</span><span class="p">,</span>
 <span class="s1">&#39;readrectangle_in_image&#39;</span><span class="p">,</span> <span class="s1">&#39;setfilename&#39;</span><span class="p">,</span> <span class="s1">&#39;stringint&#39;</span><span class="p">,</span> <span class="s1">&#39;write_rawbinary&#39;</span><span class="p">,</span> <span class="s1">&#39;writeimage&#39;</span><span class="p">,</span><span class="s1">&#39;getfilename&#39;</span><span class="p">]</span>

<span class="n">imageprocfuncs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ConvolvebyKernel&#39;</span><span class="p">,</span> <span class="s1">&#39;LoG&#39;</span><span class="p">,</span> <span class="s1">&#39;LoGArr&#39;</span><span class="p">,</span> <span class="s1">&#39;LocalMaxima_KernelConvolution&#39;</span><span class="p">,</span> <span class="s1">&#39;LocalMaxima_ShiftArrays&#39;</span><span class="p">,</span>
 <span class="s1">&#39;LocalMaxima_from_thresholdarray&#39;</span><span class="p">,</span> <span class="s1">&#39;LocalMaxima_ndimage&#39;</span><span class="p">,</span> <span class="s1">&#39;applyformula_on_images&#39;</span><span class="p">,</span> <span class="s1">&#39;blurCCD&#39;</span><span class="p">,</span> <span class="s1">&#39;blurCCD_with_binning&#39;</span><span class="p">,</span>
 <span class="s1">&#39;blur_image&#39;</span><span class="p">,</span> <span class="s1">&#39;check_array_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;circularMask&#39;</span><span class="p">,</span> <span class="s1">&#39;compute_autobackground_image&#39;</span><span class="p">,</span> <span class="s1">&#39;computefilteredimage&#39;</span><span class="p">,</span>
 <span class="s1">&#39;diff_pix&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_minimum&#39;</span><span class="p">,</span> <span class="s1">&#39;filterimage&#39;</span><span class="p">,</span> <span class="s1">&#39;gauss_kern&#39;</span><span class="p">,</span> <span class="s1">&#39;getExtrema&#39;</span><span class="p">,</span>
 <span class="s1">&#39;getIntegratedIntensity&#39;</span><span class="p">,</span> <span class="s1">&#39;getMinMax&#39;</span><span class="p">,</span> <span class="s1">&#39;getindices2cropArray&#39;</span><span class="p">,</span> <span class="s1">&#39;listfile&#39;</span><span class="p">,</span> <span class="s1">&#39;localmaxima&#39;</span><span class="p">,</span>
 <span class="s1">&#39;minmax&#39;</span><span class="p">,</span> <span class="s1">&#39;minmax_fast&#39;</span><span class="p">,</span> <span class="s1">&#39;myfromfunction&#39;</span><span class="p">,</span> <span class="s1">&#39;normalize_shape&#39;</span><span class="p">,</span>
 <span class="s1">&#39;plot_image_markers&#39;</span><span class="p">,</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;radialArr&#39;</span><span class="p">,</span> <span class="s1">&#39;rebin2Darray&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_minimum_background&#39;</span><span class="p">,</span>
 <span class="s1">&#39;shiftarrays_accum&#39;</span><span class="p">,</span> <span class="s1">&#39;to8bits&#39;</span><span class="p">]</span>


<span class="n">thismodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">warn_func_is_now_in</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">modulename</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning!  </span><span class="si">%s</span><span class="s2"> is no longer in readmccd.py but in </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">modulename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="k">for</span> <span class="n">iofunc</span> <span class="ow">in</span> <span class="n">IOimagefuncs</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">thismodule</span><span class="p">,</span> <span class="n">iofunc</span><span class="p">,</span> <span class="n">warn_func_is_now_in</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">IOimage</span><span class="p">,</span> <span class="n">iofunc</span><span class="p">),</span> <span class="s1">&#39;IOimagefile.py&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ipfunc</span> <span class="ow">in</span> <span class="n">imageprocfuncs</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">thismodule</span><span class="p">,</span> <span class="n">ipfunc</span><span class="p">,</span> <span class="n">warn_func_is_now_in</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ImProc</span><span class="p">,</span> <span class="n">ipfunc</span><span class="p">),</span> <span class="s1">&#39;imageprocessing.py&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="readoneimage_multiROIfit"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.readoneimage_multiROIfit">[docs]</a><span class="k">def</span> <span class="nf">readoneimage_multiROIfit</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">stackimageindex</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="o">=</span><span class="s2">&quot;PRINCETON&quot;</span><span class="p">,</span>
                                                                        <span class="n">baseline</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                                                                        <span class="n">startangles</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                                                        <span class="n">start_sigma1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                                                        <span class="n">start_sigma2</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                                                        <span class="n">position_start</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>
                                                                        <span class="n">fitfunc</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
                                                                        <span class="n">showfitresults</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                        <span class="n">offsetposition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                        <span class="n">xtol</span><span class="o">=</span><span class="mf">0.00000001</span><span class="p">,</span>
                                                                        <span class="n">addImax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                        <span class="n">use_data_corrected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit several peaks in one image</span>

<span class="sd">    :param filename: string, full path to image file</span>
<span class="sd">    :param centers: list or array like with shape=(n,2)</span>
<span class="sd">                    list of centers of selected ROI</span>
<span class="sd">    :param boxsize: (Truly HALF boxsize: fuill boxsize= 2(halfboxsize) +1), iterable 2 elements or integer</span>
<span class="sd">                    boxsizes [in x, in y] direction or integer to set a square ROI</span>
<span class="sd">    :param baseline: string, &#39;auto&#39; (ie minimum intensity in ROI) or array of floats</span>
<span class="sd">    :param startangles: float or iterable of 2 floats, elliptic gaussian angle (major axis with respect to X direction),</span>
<span class="sd">                        one value or array of values</span>
<span class="sd">    :param start_sigma1, start_sigma2: floats, gaussian standard deviation (major and minor axis) in pixel,</span>
<span class="sd">    :param position_start:  string, starting gaussian center:&#39;max&#39; (position of maximum intensity in ROI),</span>
<span class="sd">                            &quot;centers&quot; (centre of each ROI)</span>
<span class="sd">    :param offsetposition: integer, 0 for no offset, 1  XMAS compatible, since XMAS consider first pixel as index 1 (in array, index starts with 0), 2  fit2d, since fit2d for peaksearch put pixel labelled n at the position n+0.5 (between n and n+1)</span>
<span class="sd">    :param use_data_corrected: tuple of 3 elements, Enter data instead of reading data from file:</span>
<span class="sd">                         fulldata, framedim, fliprot</span>
<span class="sd">                         where fulldata is a ndarray</span>
<span class="sd">    :return: list of results:   bkg,  amp  (gaussian height-bkg), X , Y, major axis standard deviation, minor axis standard deviation,</span>
<span class="sd">                                major axis tilt angle / Ox</span>
<span class="sd">    .. todo:: setting list of initial guesses can be improve with</span>
<span class="sd">        scipy.ndimages of a concatenate array of multiple slices?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;addImax&quot;</span><span class="p">,</span> <span class="n">addImax</span><span class="p">)</span>
    <span class="c1">#     print &quot;entrance of readoneimage_multiROIfit&quot;, (filename,</span>
    <span class="c1">#                              centers,</span>
    <span class="c1">#                              boxsize,</span>
    <span class="c1">#                              CCDLabel,</span>
    <span class="c1">#                              baseline,</span>
    <span class="c1">#                              startangles,</span>
    <span class="c1">#                              start_sigma1,</span>
    <span class="c1">#                              start_sigma2,</span>
    <span class="c1">#                              position_start,</span>
    <span class="c1">#                              fitfunc,</span>
    <span class="c1">#                              showfitresults,</span>
    <span class="c1">#                              offsetposition,</span>
    <span class="c1">#                              verbose,</span>
    <span class="c1">#                              xtol,</span>
    <span class="c1">#                              addImax,</span>
    <span class="c1">#                              use_data_corrected)</span>

    <span class="c1"># read data (several arrays)</span>
    <span class="n">ResData</span> <span class="o">=</span> <span class="n">IOimage</span><span class="o">.</span><span class="n">readoneimage_manycrops</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">centers</span><span class="p">,</span>
                                    <span class="n">boxsize</span><span class="p">,</span>
                                    <span class="n">stackimageindex</span><span class="p">,</span>
                                    <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">,</span>
                                    <span class="n">addImax</span><span class="o">=</span><span class="n">addImax</span><span class="p">,</span>
                                    <span class="n">use_data_corrected</span><span class="o">=</span><span class="n">use_data_corrected</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">addImax</span><span class="p">:</span>
        <span class="n">Datalist</span><span class="p">,</span> <span class="n">Imax</span> <span class="o">=</span> <span class="n">ResData</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Datalist</span> <span class="o">=</span> <span class="n">ResData</span>

    <span class="n">framedim</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_CCD</span><span class="p">[</span><span class="n">CCDLabel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">saturation_value</span> <span class="o">=</span> <span class="n">DictLT</span><span class="o">.</span><span class="n">dict_CCD</span><span class="p">[</span><span class="n">CCDLabel</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#     print &quot;len(Datalist)&quot;,Datalist</span>
    <span class="c1"># for elem in Datalist:</span>
    <span class="c1">#     print(&quot;nb 2D intensities arrays&quot;,len(elem))</span>
    <span class="c1">#     print(&quot;2D array intensity shape&quot;,elem.shape)</span>
    <span class="n">Data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Datalist</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1">#     condition=Data&gt;=saturation_value</span>
    <span class="c1">#     np.ma.masked_where(condition,Data,copy=True)</span>
    <span class="c1">#</span>
    <span class="c1">#     print &quot;Data&quot;,Data</span>

    <span class="c1"># setting initial guessed values for each center</span>
    <span class="n">nb_Images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Data</span><span class="p">)</span>
    <span class="c1">#     print &quot;nb of images to fitdata ... in  readoneimage_multiROIfit()&quot;, nb_Images</span>
    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># background height or baseline level</span>
        <span class="n">list_min</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Data</span><span class="p">):</span>
            <span class="c1">#            print &quot;k, dd.shape&quot;, k, dd.shape</span>
            <span class="n">list_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
        <span class="n">start_baseline</span> <span class="o">=</span> <span class="n">list_min</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># input numerical value array</span>
        <span class="n">start_baseline</span> <span class="o">=</span> <span class="n">baseline</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startangles</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">start_anglerot</span> <span class="o">=</span> <span class="n">startangles</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_anglerot</span> <span class="o">=</span> <span class="n">startangles</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_sigma1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">start_sigma1</span> <span class="o">=</span> <span class="n">start_sigma1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_sigma2</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">start_sigma2</span> <span class="o">=</span> <span class="n">start_sigma2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxsize</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">xboxsize</span><span class="p">,</span> <span class="n">yboxsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">boxsize</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">boxsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xboxsize</span><span class="p">,</span> <span class="n">yboxsize</span> <span class="o">=</span> <span class="n">boxsize</span>

    <span class="n">Xboxsize</span> <span class="o">=</span> <span class="n">xboxsize</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>
    <span class="n">Yboxsize</span> <span class="o">=</span> <span class="n">yboxsize</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>

    <span class="n">start_j</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_i</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_amplitude</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">position_start</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;centers&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">):</span>  <span class="c1"># starting position  from input center</span>
        <span class="n">start_j</span><span class="p">,</span> <span class="n">start_i</span> <span class="o">=</span> <span class="n">yboxsize</span><span class="p">,</span> <span class="n">xboxsize</span>
        <span class="n">start_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">:</span>
            <span class="n">start_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start_j</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_i</span><span class="p">[</span><span class="n">d</span><span class="p">])]</span> <span class="o">-</span> <span class="n">start_baseline</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">position_start</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>  <span class="c1"># starting position  from maximum intensity in dat</span>

        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">:</span>
            <span class="n">start_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">//</span> <span class="n">dd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">start_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">%</span> <span class="n">dd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">start_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_baseline</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">startingparams_zip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start_baseline</span><span class="p">,</span> <span class="n">start_amplitude</span><span class="p">,</span>
                                    <span class="n">start_j</span><span class="p">,</span> <span class="n">start_i</span><span class="p">,</span>
                                    <span class="n">start_sigma1</span><span class="p">,</span> <span class="n">start_sigma2</span><span class="p">,</span>
                                    <span class="n">start_anglerot</span><span class="p">])</span>

    <span class="n">RES_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RES_cov</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RES_infodict</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RES_errmsg</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;startingparams_zip&quot;</span><span class="p">,</span> <span class="n">startingparams_zip</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># consider that ROi shape will be constant over all ROIs,</span>
    <span class="c1"># so no need to recompute np.indices in gaussfit</span>
    <span class="n">ROIshape</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ijindices_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">ROIshape</span><span class="p">)</span>

    <span class="n">k_image</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">startingparams</span> <span class="ow">in</span> <span class="n">startingparams_zip</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
        <span class="c1"># if (k_image%25) == 0: print &quot;%d/%d&quot;%(k_image,nb_Images)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;startingparams&quot;</span><span class="p">,</span> <span class="n">startingparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fitfunc</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">ROIshape</span><span class="p">:</span>
                <span class="n">ijindices_array</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># ROIdata = Data[k_image]</span>
            <span class="c1">#             print &#39;ROIdata&#39;, ROIdata</span>
            <span class="c1">#             print &#39;np.amax(ROIdata)&#39;, np.amax(ROIdata)</span>
            <span class="c1">#             print &#39;np.amin (ROIdata)&#39;, np.amin(ROIdata)</span>
            <span class="c1">#             print &#39;np.argmax (ROIdata)&#39;, np.argmax(ROIdata)</span>

            <span class="n">params</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="n">fit2d</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="n">k_image</span><span class="p">],</span>
                                                    <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">params</span><span class="o">=</span><span class="n">startingparams</span><span class="p">,</span>
                                                    <span class="n">autoderiv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">return_all</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">circle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">rotate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">vheight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                                    <span class="n">Acceptable_HighestValue</span><span class="o">=</span><span class="n">saturation_value</span><span class="p">,</span>
                                                    <span class="n">Acceptable_LowestValue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">ijindices_array</span><span class="o">=</span><span class="n">ijindices_array</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">fitfunc</span> <span class="o">==</span> <span class="s2">&quot;lorentzian&quot;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="n">fit2d_l</span><span class="o">.</span><span class="n">lorentzfit</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="n">k_image</span><span class="p">],</span>
                                                                <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                <span class="n">params</span><span class="o">=</span><span class="n">startingparams</span><span class="p">,</span>
                                                                <span class="n">autoderiv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">return_all</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">circle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                <span class="n">rotate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">vheight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">showfitresults</span><span class="p">:</span>
            <span class="c1"># print &quot;startingparams&quot;</span>
            <span class="c1"># print startingparams</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *****fitting results ************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;background intensity:                        </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak amplitude above background              </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pixel position (X)                   </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>  <span class="c1"># WARNING Y and X are exchanged in params !</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pixel position (Y)                   </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Yboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;std 1,std 2 (pix)                    ( </span><span class="si">{:.2f}</span><span class="s2"> , </span><span class="si">{:.2f}</span><span class="s2"> )&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;e=min(std1,std2)/max(std1,std2)              </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rotation angle (deg)                 </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">%</span> <span class="mi">360</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bkg_sol</span><span class="p">,</span> <span class="n">amp_sol</span><span class="p">,</span> <span class="n">Y_sol</span><span class="p">,</span> <span class="n">X_sol</span><span class="p">,</span> <span class="n">std1_sol</span><span class="p">,</span> <span class="n">std2_sol</span><span class="p">,</span> <span class="n">ang_sol</span> <span class="o">=</span> <span class="n">params</span>

        <span class="n">RES_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="n">RES_infodict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">infodict</span><span class="p">)</span>
        <span class="n">RES_errmsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="n">params_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bkg_sol</span><span class="p">,</span> <span class="n">amp_sol</span><span class="p">,</span>
                <span class="n">X_sol</span> <span class="o">-</span> <span class="n">Xboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">Y_sol</span> <span class="o">-</span> <span class="n">Yboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">std1_sol</span><span class="p">,</span>
                <span class="n">std2_sol</span><span class="p">,</span>
                <span class="n">ang_sol</span><span class="p">])</span>  <span class="c1"># now X,Y in safest order</span>

        <span class="k">if</span> <span class="n">offsetposition</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># PATCH: To match peak positions given by XMAS</span>
            <span class="c1"># (confusion coming from counting array indices from 0 or 1...)</span>
            <span class="c1"># array fitted by python module see pixels at lower position</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="c1"># End of PATCH</span>

        <span class="k">elif</span> <span class="n">offsetposition</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># see Compute_data2thetachi() in find2thetachi.py</span>
            <span class="c1"># PATCH: To match peak positions given by peaksearch of fit2D</span>
            <span class="c1"># in fit2D graphics window first pixel labelled 1 is for the</span>
            <span class="c1"># peaksearch located at position in  between 0 and 1 (ie 0.5)</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">framedim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># TODO: tocheck dim[0] or dim[1]</span>
            <span class="c1"># End of PATCH</span>

        <span class="n">RES_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params_sol</span><span class="p">)</span>

        <span class="n">k_image</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">addImax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RES_params</span><span class="p">,</span> <span class="n">RES_cov</span><span class="p">,</span> <span class="n">RES_infodict</span><span class="p">,</span> <span class="n">RES_errmsg</span><span class="p">,</span> <span class="n">start_baseline</span><span class="p">,</span> <span class="n">Imax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RES_params</span><span class="p">,</span> <span class="n">RES_cov</span><span class="p">,</span> <span class="n">RES_infodict</span><span class="p">,</span> <span class="n">RES_errmsg</span><span class="p">,</span> <span class="n">start_baseline</span></div>


<div class="viewcode-block" id="fitPeakMultiROIs"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.fitPeakMultiROIs">[docs]</a><span class="k">def</span> <span class="nf">fitPeakMultiROIs</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">FittingParametersDict</span><span class="p">,</span> <span class="n">showfitresults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; refine all peaks  guessed to be at center of several ROIs</span>

<span class="sd">    :param Data: list of Data array centered on peaks</span>
<span class="sd">    :param centers: list of pixels (x,y) positions of ROI centers</span>
<span class="sd">    :param FittingParametersDict: dict of fitting parameters</span>

<span class="sd">    :return: RES_params, RES_cov, RES_infodict, RES_errmsg, start_baseline</span>
<span class="sd">            which are all list of refinement results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boxsize</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;boxsize&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bosize&quot;</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">boxsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">boxsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;boxsize&quot;</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;boxsizes are not odd !!&quot;</span><span class="p">)</span>

    <span class="n">framedim</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;framedim&quot;</span><span class="p">]</span>
    <span class="n">saturation_value</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;saturation_value&quot;</span><span class="p">]</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span>

    <span class="n">startangles</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;startangles&quot;</span><span class="p">]</span>
    <span class="n">position_start</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;position_start&quot;</span><span class="p">]</span>
    <span class="n">start_sigma1</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;start_sigma1&quot;</span><span class="p">]</span>
    <span class="n">start_sigma2</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;start_sigma2&quot;</span><span class="p">]</span>

    <span class="n">fitfunc</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;fitfunction&quot;</span><span class="p">]</span>
    <span class="n">xtol</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">]</span>
    <span class="n">offsetposition</span> <span class="o">=</span> <span class="n">FittingParametersDict</span><span class="p">[</span><span class="s2">&quot;offsetposition&quot;</span><span class="p">]</span>

    <span class="c1"># setting initial guessed values for each center</span>
    <span class="n">nb_Images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nb of images fitPeakMultiROIs&quot;</span><span class="p">,</span> <span class="n">nb_Images</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape of Data&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># background height or baseline level</span>
        <span class="n">list_min</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Data</span><span class="p">):</span>
            <span class="c1">#            print &quot;k, dd.shape&quot;, k, dd.shape</span>
            <span class="n">list_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span>
        <span class="n">start_baseline</span> <span class="o">=</span> <span class="n">list_min</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># input numerical value array</span>
        <span class="n">start_baseline</span> <span class="o">=</span> <span class="n">baseline</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startangles</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">start_anglerot</span> <span class="o">=</span> <span class="n">startangles</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_anglerot</span> <span class="o">=</span> <span class="n">startangles</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_sigma1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">start_sigma1</span> <span class="o">=</span> <span class="n">start_sigma1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_sigma2</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">start_sigma2</span> <span class="o">=</span> <span class="n">start_sigma2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxsize</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">xboxsize</span><span class="p">,</span> <span class="n">yboxsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">boxsize</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">boxsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xboxsize</span><span class="p">,</span> <span class="n">yboxsize</span> <span class="o">=</span> <span class="n">boxsize</span>

    <span class="n">halfxboxsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xboxsize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">halfyboxsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yboxsize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="n">Xhalfboxsize</span> <span class="o">=</span> <span class="n">halfxboxsize</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>
    <span class="n">Yhalfboxsize</span> <span class="o">=</span> <span class="n">halfyboxsize</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nb_Images</span><span class="p">)</span>

    <span class="n">start_j</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_i</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_amplitude</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">position_start</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;centers&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">):</span>  <span class="c1"># starting position  from input center</span>
        <span class="n">start_j</span><span class="p">,</span> <span class="n">start_i</span> <span class="o">=</span> <span class="n">halfyboxsize</span><span class="p">,</span> <span class="n">halfxboxsize</span>
        <span class="n">start_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">:</span>
            <span class="n">start_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start_j</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_i</span><span class="p">[</span><span class="n">d</span><span class="p">])]</span> <span class="o">-</span> <span class="n">start_baseline</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">position_start</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>  <span class="c1"># starting position  from maximum intensity in dat</span>

        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">:</span>
            <span class="n">start_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">//</span> <span class="n">dd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">start_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">%</span> <span class="n">dd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">start_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_baseline</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">startingparams_zip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start_baseline</span><span class="p">,</span> <span class="n">start_amplitude</span><span class="p">,</span> <span class="n">start_j</span><span class="p">,</span> <span class="n">start_i</span><span class="p">,</span>
                            <span class="n">start_sigma1</span><span class="p">,</span> <span class="n">start_sigma2</span><span class="p">,</span> <span class="n">start_anglerot</span><span class="p">])</span>

    <span class="n">RES_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RES_cov</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RES_infodict</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RES_errmsg</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;startingparams_zip&quot;</span><span class="p">,</span> <span class="n">startingparams_zip</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># consider that ROi shape will be constant over all ROIs,</span>
    <span class="c1"># so no need to recompute np.indices in gaussfit</span>
    <span class="n">ROIshape</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ijindices_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">ROIshape</span><span class="p">)</span>

    <span class="n">k_image</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">startingparams</span> <span class="ow">in</span> <span class="n">startingparams_zip</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
        <span class="c1"># if (k_image%25) == 0: print &quot;%d/%d&quot;%(k_image,nb_Images)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;startingparams&quot;</span><span class="p">,</span> <span class="n">startingparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fitfunc</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">ROIshape</span><span class="p">:</span>
                <span class="n">ijindices_array</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">params</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="n">fit2d</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="n">k_image</span><span class="p">],</span>
                                                            <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">params</span><span class="o">=</span><span class="n">startingparams</span><span class="p">,</span>
                                                            <span class="n">autoderiv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">return_all</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">circle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">rotate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">vheight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                                            <span class="n">Acceptable_HighestValue</span><span class="o">=</span><span class="n">saturation_value</span><span class="p">,</span>
                                                            <span class="n">Acceptable_LowestValue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">ijindices_array</span><span class="o">=</span><span class="n">ijindices_array</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">fitfunc</span> <span class="o">==</span> <span class="s2">&quot;lorentzian&quot;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="n">fit2d_l</span><span class="o">.</span><span class="n">lorentzfit</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="n">k_image</span><span class="p">],</span>
                                                                <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                <span class="n">params</span><span class="o">=</span><span class="n">startingparams</span><span class="p">,</span>
                                                                <span class="n">autoderiv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">return_all</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">circle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                <span class="n">rotate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">vheight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">showfitresults</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *****fitting results ************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  for k_image = &quot;</span><span class="p">,</span> <span class="n">k_image</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;background intensity:                        </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak amplitude above background              </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pixel position (X)                   </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xhalfboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># WARNING Y and X are exchanged</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pixel position (Y)                   </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Yhalfboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;std 1,std 2 (pix)                    ( </span><span class="si">{:.2f}</span><span class="s2"> , </span><span class="si">{:.2f}</span><span class="s2"> )&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;e=min(std1,std2)/max(std1,std2)              </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rotation angle (deg)                 </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">%</span> <span class="mi">360</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Xboxsize[k_image]&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">Xhalfboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;centers[k_image][0]&quot;</span><span class="p">,</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bkg_sol</span><span class="p">,</span> <span class="n">amp_sol</span><span class="p">,</span> <span class="n">Y_sol</span><span class="p">,</span> <span class="n">X_sol</span><span class="p">,</span> <span class="n">std1_sol</span><span class="p">,</span> <span class="n">std2_sol</span><span class="p">,</span> <span class="n">ang_sol</span> <span class="o">=</span> <span class="n">params</span>

        <span class="n">RES_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="n">RES_infodict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">infodict</span><span class="p">)</span>
        <span class="n">RES_errmsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="n">params_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bkg_sol</span><span class="p">,</span> <span class="n">amp_sol</span><span class="p">,</span>
                <span class="n">X_sol</span> <span class="o">-</span> <span class="n">Xhalfboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">Y_sol</span> <span class="o">-</span> <span class="n">Yhalfboxsize</span><span class="p">[</span><span class="n">k_image</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="n">k_image</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">std1_sol</span><span class="p">,</span>
                <span class="n">std2_sol</span><span class="p">,</span>
                <span class="n">ang_sol</span><span class="p">])</span>  <span class="c1"># now X,Y in safest order</span>

        <span class="k">if</span> <span class="n">offsetposition</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># PATCH: To match peak positions given by XMAS</span>
            <span class="c1"># (confusion coming from counting array indices from 0 or 1...)</span>
            <span class="c1"># array fitted by python module see pixels at lower position</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="c1"># End of PATCH</span>

        <span class="k">elif</span> <span class="n">offsetposition</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># see Compute_data2thetachi() in find2thetachi.py</span>
            <span class="c1"># PATCH: To match peak positions given by peaksearch of fit2D</span>
            <span class="c1"># in fit2D graphics window first pixel labelled 1 is for the</span>
            <span class="c1"># peaksearch located at position in  between 0 and 1 (ie 0.5)</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">framedim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">params_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># TODO: tocheck dim[0] or dim[1]</span>
            <span class="c1"># End of PATCH</span>

        <span class="n">RES_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params_sol</span><span class="p">)</span>

        <span class="n">k_image</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">RES_params</span><span class="p">,</span> <span class="n">RES_cov</span><span class="p">,</span> <span class="n">RES_infodict</span><span class="p">,</span> <span class="n">RES_errmsg</span><span class="p">,</span> <span class="n">start_baseline</span></div>





<div class="viewcode-block" id="getIntegratedIntensities"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.getIntegratedIntensities">[docs]</a><span class="k">def</span> <span class="nf">getIntegratedIntensities</span><span class="p">(</span><span class="n">fullpathimagefile</span><span class="p">,</span>
                            <span class="n">list_centers</span><span class="p">,</span>
                            <span class="n">boxsize</span><span class="p">,</span>
                            <span class="n">CCDLabel</span><span class="o">=</span><span class="s2">&quot;MARCCD165&quot;</span><span class="p">,</span>
                            <span class="n">thresholdlevel</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                            <span class="n">flipxycenter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read binary image file and compute integrated intensities of peaks</span>
<span class="sd">    whose center is given in list_centers</span>

<span class="sd">    :return: array whose columns are:</span>
<span class="sd">        - integrated intensity</span>
<span class="sd">        - absolute minimum intensity threshold</span>
<span class="sd">        - nb of pixels composing the peak</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataimage</span><span class="p">,</span> <span class="n">framedim</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">IOimage</span><span class="o">.</span><span class="n">readCCDimage</span><span class="p">(</span><span class="n">fullpathimagefile</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">list_centers</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImProc</span><span class="o">.</span><span class="n">getIntegratedIntensity</span><span class="p">(</span><span class="n">dataimage</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">framedim</span><span class="p">,</span>
                                                        <span class="n">thresholdlevel</span><span class="p">,</span> <span class="n">flipxycenter</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">Find_optimal_thresholdconvolveValue</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">IntensityThreshold</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="o">=</span><span class="s2">&quot;PRINCETON&quot;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    give the lowest value for thresholdconvolve according to IntensityThreshold</span>
<span class="sd">    in order not to miss any blob detection in the first filtering</span>
<span class="sd">    (by convolution)</span>
<span class="sd">    that would be accepted in the second filtering</span>
<span class="sd">    (thresholding by IntensityThreshold)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># image = scipy.misc.lena().astype(float32)</span>
    <span class="c1">#    d = readoneimage(filename).reshape((2048,2048))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="c1"># tstart = ttt.time()</span>
        <span class="c1"># Isorted, fitpeak, localpeak, nbrawblobs</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">fitpeak</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nbrawblobs</span> <span class="o">=</span> <span class="n">PeakSearch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                                <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">,</span>
                                                <span class="n">PixelNearRadius</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                <span class="n">removeedge</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">IntensityThreshold</span><span class="o">=</span><span class="n">IntensityThreshold</span><span class="p">,</span>
                                                <span class="n">thresholdConvolve</span><span class="o">=</span><span class="n">tc</span><span class="p">,</span>
                                                <span class="n">boxsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                <span class="n">position_definition</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                <span class="n">fit_peaks_gaussian</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                <span class="n">xtol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                                <span class="n">return_histo</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># res.append([tc,IntensityThreshold, nbrawblobs,len(fitpeak), ttt.time()-tstart])</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tc</span><span class="p">,</span> <span class="n">IntensityThreshold</span><span class="p">,</span> <span class="n">nbrawblobs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitpeak</span><span class="p">)])</span>

    <span class="n">Res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">Res</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Res</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># if False  ==&gt; threshold after convolution is too high, some blob may have been rejected before intensity thresholding</span>
    <span class="n">indices_False</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">optim_value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_False</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">indices_False</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">optim_value</span> <span class="o">=</span> <span class="n">Res</span><span class="p">[</span><span class="n">indices_False</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optim value for thresholdConvolve&quot;</span><span class="p">,</span> <span class="n">optim_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optim_value</span><span class="p">,</span> <span class="n">Res</span>





<div class="viewcode-block" id="writepeaklist"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.writepeaklist">[docs]</a><span class="k">def</span> <span class="nf">writepeaklist</span><span class="p">(</span><span class="n">tabpeaks</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span>
                                        <span class="n">outputfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    write peaks properties and comments in file with extension .dat added</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outputfilefullpath</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">writefile_Peaklist</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span>
                                                <span class="n">tabpeaks</span><span class="p">,</span>
                                                <span class="n">dirname</span><span class="o">=</span><span class="n">outputfolder</span><span class="p">,</span>
                                                <span class="n">overwrite</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">initialfilename</span><span class="o">=</span><span class="n">initialfilename</span><span class="p">,</span>
                                                <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outputfilefullpath</span></div>


<div class="viewcode-block" id="fitoneimage_manypeaks"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.fitoneimage_manypeaks">[docs]</a><span class="k">def</span> <span class="nf">fitoneimage_manypeaks</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="n">stackimageindex</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">CCDLabel</span><span class="o">=</span><span class="s2">&quot;PRINCETON&quot;</span><span class="p">,</span>
                                                    <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">position_start</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>
                                                    <span class="n">type_of_function</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
                                                    <span class="n">guessed_peaksize</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                                                    <span class="n">xtol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                                    <span class="n">FitPixelDev</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                                    <span class="n">Ipixmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">MaxIntensity</span><span class="o">=</span><span class="mi">100000000000</span><span class="p">,</span>
                                                    <span class="n">MinIntensity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">PeakSizeRange</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                                                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">position_definition</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">NumberMaxofFits</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                                    <span class="n">ComputeIpixmax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">use_data_corrected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">reject_negative_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">purgeDuplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fit multiple ROI data to get peaks position in a single image</span>

<span class="sd">    Ipixmax  :  highest intensity above background in every ROI centered on element of peaklist</span>

<span class="sd">    use_data_corrected   :  enter data instead of reading data from file</span>
<span class="sd">                        must be a tuple of 3 elements:</span>
<span class="sd">                        fulldata, framedim, fliprot</span>
<span class="sd">                        where fulldata is an ndarray</span>

<span class="sd">    purgeDuplicates    : True   remove duplicates that are close within pixel distance of &#39;boxsize&#39; and keep the most intense peak</span>

<span class="sd">    use_data_corrected   :  enter data instead of reading data from file</span>
<span class="sd">                        must be a tuple of 3 elements:</span>
<span class="sd">                        fulldata, framedim, fliprot</span>
<span class="sd">                        where fulldata  ndarray</span>

<span class="sd">    .. note:: used in PeakSearchGUI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     print &#39;Ipixmax in fitoneimage_manypeaks&#39;, Ipixmax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">NumberMaxofFits</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOO MUCH peaks to fitdata.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(in fitoneimage_manypeaks) It may stuck the computer.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Try to reduce the number of Local Maxima or reduce NumberMaxofFits in fitoneimage_manypeaks()&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">dirname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">start_sigma1</span><span class="p">,</span> <span class="n">start_sigma2</span> <span class="o">=</span> <span class="n">guessed_peaksize</span>

    <span class="n">tstart</span> <span class="o">=</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">ResFit</span> <span class="o">=</span> <span class="n">readoneimage_multiROIfit</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                        <span class="n">peaklist</span><span class="p">,</span>
                                        <span class="n">boxsize</span><span class="p">,</span>
                                        <span class="n">stackimageindex</span><span class="p">,</span>
                                        <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">,</span>
                                        <span class="n">baseline</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>  <span class="c1"># min in ROI box</span>
                                        <span class="n">startangles</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                        <span class="n">start_sigma1</span><span class="o">=</span><span class="n">start_sigma1</span><span class="p">,</span>
                                        <span class="n">start_sigma2</span><span class="o">=</span><span class="n">start_sigma2</span><span class="p">,</span>
                                        <span class="n">position_start</span><span class="o">=</span><span class="n">position_start</span><span class="p">,</span>  <span class="c1"># &#39;centers&#39; or &#39;max&#39;</span>
                                        <span class="n">showfitresults</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">offsetposition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># offset are applied after fit</span>
                                        <span class="n">fitfunc</span><span class="o">=</span><span class="n">type_of_function</span><span class="p">,</span>
                                        <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                        <span class="n">addImax</span><span class="o">=</span><span class="n">ComputeIpixmax</span><span class="p">,</span>
                                        <span class="n">use_data_corrected</span><span class="o">=</span><span class="n">use_data_corrected</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fitting time for </span><span class="si">{}</span><span class="s2"> peaks is : </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">),</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nb of results: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ResFit</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">ComputeIpixmax</span><span class="p">:</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">ResFit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">baseline</span> <span class="o">=</span> <span class="n">ResFit</span>

    <span class="n">par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1">#    print &quot;par in fitoneimage_manypeaks&quot;, par</span>

    <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no fitted peaks&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">peak_bkg</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">peak_I</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">peak_X</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">peak_Y</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">peak_fwaxmaj</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">peak_fwaxmin</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">peak_inclination</span> <span class="o">=</span> <span class="n">par</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">%</span> <span class="mi">360</span>

    <span class="c1"># pixel deviations from guessed initial position before fitting</span>
    <span class="n">Xdev</span> <span class="o">=</span> <span class="n">peak_X</span> <span class="o">-</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">Ydev</span> <span class="o">=</span> <span class="n">peak_Y</span> <span class="o">-</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1">#     print &quot;peak_X&quot;,peak_X</span>
    <span class="c1">#     print &quot;peaklist[:, 0]&quot;,peaklist[:, 0]</span>
    <span class="c1">#     print &#39;Xdev&#39;, Xdev</span>
    <span class="c1">#     print &quot;Ydev&quot;, Ydev</span>

    <span class="c1"># --- --- PEAKS REJECTION -------------------------------</span>
    <span class="c1"># print &quot;peaklist[:20]&quot;,peaklist[:]</span>
    <span class="c1"># number of iteration screening</span>
    <span class="n">to_reject</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">inf</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inf</span><span class="p">[</span><span class="s2">&quot;nfev&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1550</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k= </span><span class="si">{}</span><span class="s2">   too much iteration&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">to_reject</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">CCDLabel</span> <span class="o">==</span> <span class="s2">&quot;FRELONID15_corrected&quot;</span><span class="p">:</span>
        <span class="n">reject_negative_baseline</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># negative intensity rejection</span>
    <span class="k">if</span> <span class="n">reject_negative_baseline</span><span class="p">:</span>
        <span class="n">to_reject2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">peak_bkg</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_reject2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># too far found peak rejection</span>
    <span class="n">to_reject3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Xdev</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Ydev</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">FitPixelDev</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#     print &#39;to_reject3&#39;, to_reject3</span>

    <span class="c1">#     print &quot;peak_I&quot;,peak_I</span>

    <span class="c1"># too intense compared to given threshold (saturation)</span>
    <span class="n">to_reject4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">peak_I</span> <span class="o">&gt;=</span> <span class="n">MaxIntensity</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># too weak compared to given threshold</span>
    <span class="n">to_reject5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">peak_I</span> <span class="o">&lt;=</span> <span class="n">MinIntensity</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">maxpeaksize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">peak_fwaxmaj</span><span class="p">,</span> <span class="n">peak_fwaxmin</span><span class="p">)</span>

    <span class="c1"># too small peak compared to given threshold</span>
    <span class="n">to_reject6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">maxpeaksize</span> <span class="o">&lt;=</span> <span class="n">PeakSizeRange</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># too large peak compared to given threshold</span>
    <span class="n">to_reject7</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">maxpeaksize</span> <span class="o">&gt;=</span> <span class="n">PeakSizeRange</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to_reject&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">to_reject</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to_reject ...(len)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_reject</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">peaklist</span><span class="p">,</span> <span class="n">to_reject</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to_reject2 ...(len)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_reject2</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">peaklist</span><span class="p">,</span> <span class="n">to_reject2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">peaklist</span><span class="p">,</span> <span class="n">to_reject3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After fitting, </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> peaks have been rejected</span><span class="se">\n</span><span class="s2"> due to (final - initial position)&gt; FitPixelDev = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">to_reject3</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">),</span> <span class="n">FitPixelDev</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> spots have been rejected</span><span class="se">\n</span><span class="s2"> due to negative baseline&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_reject2</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> spots have been rejected</span><span class="se">\n</span><span class="s2"> due to much intensity &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_reject4</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> spots have been rejected</span><span class="se">\n</span><span class="s2"> due to weak intensity &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_reject5</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> spots have been rejected</span><span class="se">\n</span><span class="s2"> due to small peak size&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_reject6</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> spots have been rejected</span><span class="se">\n</span><span class="s2"> due to large peak size&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_reject7</span><span class="p">)))</span>

    <span class="c1"># spots indices to reject</span>
    <span class="n">ToR</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">to_reject</span><span class="p">)</span>
        <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_reject2</span><span class="p">)</span>
        <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_reject3</span><span class="p">)</span>
        <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_reject4</span><span class="p">)</span>
        <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_reject5</span><span class="p">)</span>
        <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_reject6</span><span class="p">)</span>
        <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_reject7</span><span class="p">))</span>  <span class="c1"># to reject</span>

    <span class="c1"># spot indices to take</span>
    <span class="n">ToTake</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)))</span> <span class="o">-</span> <span class="n">ToR</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index ToTake&quot;</span><span class="p">,</span> <span class="n">ToTake</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nb indices in ToTake&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ToTake</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ToTake</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">peaklist</span>

    <span class="c1">#     print &quot;Ipixmax&quot;,Ipixmax</span>
    <span class="k">if</span> <span class="n">Ipixmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">peak_I</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ask for maximum intensity in ROI, see</span>
        <span class="k">pass</span>

    <span class="c1"># all peaks list building</span>
    <span class="n">tabpeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">peak_X</span><span class="p">,</span> <span class="n">peak_Y</span><span class="p">,</span> <span class="n">peak_I</span><span class="p">,</span> <span class="n">peak_fwaxmaj</span><span class="p">,</span> <span class="n">peak_fwaxmin</span><span class="p">,</span> <span class="n">peak_inclination</span><span class="p">,</span>
                        <span class="n">Xdev</span><span class="p">,</span> <span class="n">Ydev</span><span class="p">,</span> <span class="n">peak_bkg</span><span class="p">,</span> <span class="n">Ipixmax</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># print(&quot;Results of all fits in tabpeak&quot;, tabpeak)</span>

    <span class="n">tabpeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">tabpeak</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">ToTake</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#     print &quot;tabpeak.shape&quot;,tabpeak.shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabpeak</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># several peaks</span>
        <span class="n">intense_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tabpeak</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># sort by decreasing intensity-bkg</span>
        <span class="c1">#    print &quot;intense_rank&quot;, intense_rank</span>

        <span class="n">tabIsorted</span> <span class="o">=</span> <span class="n">tabpeak</span><span class="p">[</span><span class="n">intense_rank</span><span class="p">]</span>
    <span class="c1">#         print &quot;tabIsorted.shape case 1&quot;,tabIsorted.shape</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># single peak</span>
        <span class="c1">#         tabIsorted = np.array(tabpeak)[:,0]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tabIsorted.shape case 2&quot;</span><span class="p">,</span> <span class="n">tabIsorted</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">position_definition</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># XMAS offset</span>
        <span class="n">tabIsorted</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tabIsorted</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Intensity sorted</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabIsorted</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X,Y&quot;</span><span class="p">,</span> <span class="n">tabIsorted</span><span class="p">[:</span><span class="mi">10</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> fitted peak(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tabIsorted</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">purgeDuplicates</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabIsorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing duplicates from fit&quot;</span><span class="p">)</span>

        <span class="c1"># remove duplicates (close points), the most intense pixel is kept</span>
        <span class="c1"># minimum distance fit solutions</span>
        <span class="n">pixeldistance</span> <span class="o">=</span> <span class="n">boxsize</span>

        <span class="c1"># tabXY, index_todelete</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">index_todelete</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">purgeClosePoints2</span><span class="p">(</span><span class="n">tabIsorted</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">pixeldistance</span><span class="p">)</span>

        <span class="c1">#         print tabXY</span>
        <span class="c1">#         print index_todelete</span>

        <span class="n">tabIsorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tabIsorted</span><span class="p">,</span> <span class="n">index_todelete</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> peaks found after removing duplicates minimum intermaxima distance = </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tabIsorted</span><span class="p">),</span> <span class="n">pixeldistance</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">tabIsorted</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">peaklist</span></div>


<div class="viewcode-block" id="PeakSearch"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.PeakSearch">[docs]</a><span class="k">def</span> <span class="nf">PeakSearch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stackimageindex</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="o">=</span><span class="s2">&quot;PRINCETON&quot;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">boxsizeROI</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>  <span class="c1"># use only if center != None</span>
                                                <span class="n">PixelNearRadius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                <span class="n">removeedge</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">IntensityThreshold</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                                                <span class="n">thresholdConvolve</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                                <span class="n">paramsHat</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                                <span class="n">boxsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                <span class="n">position_definition</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">local_maxima_search_method</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">peakposition_definition</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>
                                                <span class="n">fit_peaks_gaussian</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">xtol</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
                                                <span class="n">return_histo</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">FitPixelDev</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>  <span class="c1"># to_reject3 parameter</span>
                                                <span class="n">write_execution_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">Saturation_value</span><span class="o">=</span><span class="mi">65535</span><span class="p">,</span>  <span class="c1"># to be merged in CCDLabel</span>
                                                <span class="n">Saturation_value_flatpeak</span><span class="o">=</span><span class="mi">65535</span><span class="p">,</span>
                                                <span class="n">MinIntensity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                <span class="n">PeakSizeRange</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                                                <span class="n">Data_for_localMaxima</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">Fit_with_Data_for_localMaxima</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                <span class="n">Remove_BlackListedPeaks_fromfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">maxPixelDistanceRejection</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
                                                <span class="n">NumberMaxofFits</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                                                <span class="n">reject_negative_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">formulaexpression</span><span class="o">=</span><span class="s2">&quot;A-1.1*B&quot;</span><span class="p">,</span>
                                                <span class="n">listrois</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find local intensity maxima as starting position for fittinng and return peaklist.</span>

<span class="sd">    :param filename: string, full path to image data file</span>

<span class="sd">    :param stackimageindex: integer, index corresponding to the position of image data on a stacked images file</span>
<span class="sd">                if -1  means single image data w/o stacking</span>

<span class="sd">    :param CCDLabel: string, label for CCD 2D detector used to read the image data file see dict_LaueTools.py</span>

<span class="sd">    :param center: position</span>

<span class="sd">    .. todo:: to be removed: position of the ROI center in CCD frame</span>

<span class="sd">    :param boxsizeROI: dimensions of the ROI to crop the data array</span>
<span class="sd">                    only used if center != None</span>

<span class="sd">    :param boxsize: half length of the selected ROI array centered on each peak, used for:</span>
<span class="sd">                - fitting a peak</span>
<span class="sd">                - estimating the background around a peak</span>
<span class="sd">                - shifting array in second method of local maxima search (shifted arrays)</span>

<span class="sd">    :param IntensityThreshold: integer, pixel intensity level above which potential peaks are kept for fitting position procedure. For local maxima method 0 and 1, this level is relative to zero intensity. For local maxima method 2, this level is relative to lowest intensity in the ROI (local background). Advice: start with high value, because if too high, few peaks are found (only the most important), and if too low, too many local maxima are found leading to time consuming fitting procedure.</span>

<span class="sd">    :param thresholdConvolve: integer, pixel intensity level in convolved image above which potential peaks are kept for fitting position procedure. This threshold step on convolved image is applied prior to the local threshold step with IntensityThreshold on initial image (with respect to the local background)</span>

<span class="sd">    :param paramsHat: mexican hat kernel parameters (see :func:`LocalMaxima_ndimage`)</span>

<span class="sd">    :param PixelNearRadius: integer, pixel distance between two regions considered as peaks. Advice: start rather with a large value. If too low, there are very much peaks duplicates and this is very time consuming.</span>

<span class="sd">    :param local_maxima_search_method: integer, Select method for find the local maxima, each of them will fitted</span>
<span class="sd">                            - 0   extract all pixel above intensity threshold</span>
<span class="sd">                            - 1   find pixels are highest than their neighbours in horizontal, vertica and diagonal direction (up to a given pixel distance)</span>
<span class="sd">                            - 2   find local hot pixels which after numerical convolution give high intensity above threshold (thresholdConvolve) then threshold (IntensityThreshold) on raw data</span>

<span class="sd">    :param peakposition_definition: &#39;max&#39; or &#39;center&#39;  for local_maxima_search_method == 2 to assign to the blob position its hottest pixel position or its center (no weight)</span>

<span class="sd">    :param Saturation_value_flatpeak: saturation value of detector for local maxima search method 1</span>

<span class="sd">    :param Remove_BlackListedPeaks_fromfile: None or full file path to a peaklist file containing peaks</span>
<span class="sd">                                            that will be deleted in peak list resulting from</span>
<span class="sd">                                            the local maxima search procedure (prior to peak refinement)</span>

<span class="sd">    :param maxPixelDistanceRejection: maximum distance between black listed peaks and current peaks</span>
<span class="sd">                                    (found by peak search) to be rejected</span>

<span class="sd">    :param NumberMaxofFits: highest acceptable number of local maxima peak to be refined with a 2D modelPeakSearch</span>

<span class="sd">    :param fit_peaks_gaussian:</span>
<span class="sd">        - 0  no position and shape refinement procedure performed from local maxima (or blob) result</span>
<span class="sd">        - 1  2D gaussian peak refinement</span>
<span class="sd">        - 2  2D lorentzian peak refinement</span>

<span class="sd">    :param xtol: relative error on solution (x vector)  see args for leastsq in scipy.optimize</span>
<span class="sd">    :param FitPixelDev: largest pixel distance between initial (from local maxima search)</span>
<span class="sd">                            and refined peak position</span>

<span class="sd">    :param position_definition: due to various conventional habits when reading array, add some offset to fitdata XMAS or fit2d peak search values:</span>
<span class="sd">        - 0    no offset (python numpy convention)</span>
<span class="sd">        - 1   XMAS offset</span>
<span class="sd">        - 2   fit2d offset</span>

<span class="sd">    :param return_histo: 0   3 output elements</span>
<span class="sd">                        : 1   4 elemts, last one is histogram of data</span>
<span class="sd">                        : 2   4 elemts, last one is the nb of raw blob found after convolution and threshold</span>

<span class="sd">    :param Data_for_localMaxima:  object to be used only for initial step of finding local maxima (blobs) search</span>
<span class="sd">                                (and not necessarly for peaks fitting procedure):</span>
<span class="sd">                              -  ndarray     = array data</span>
<span class="sd">                              - &#39;auto_background&#39;  = calculate and remove background computed from image data itself (read in file &#39;filename&#39;)</span>
<span class="sd">                              - path to image file (string)  = B image to be used in a mathematical operation with Ato current image</span>

<span class="sd">    :param Fit_with_Data_for_localMaxima: use &#39;Data_for_localMaxima&#39; object as image when refining peaks position and shape</span>
<span class="sd">                                       with initial peak position guess from local maxima search</span>

<span class="sd">    :param formulaexpression: string containing A (raw data array image) and B (other data array image)</span>
<span class="sd">                            expressing mathematical operation,e.g:</span>
<span class="sd">                            &#39;A-3.2*B+10000&#39;</span>
<span class="sd">                            for simple background substraction (with B as background data):</span>
<span class="sd">                            &#39;A-B&#39; or &#39;A-alpha*B&#39; with alpha &gt; 1.</span>

<span class="sd">    :param reject_negative_baseline:  True  reject refined peak result if intensity baseline (local background) is negative</span>
<span class="sd">                                        (2D model is maybe not suitable)</span>

<span class="sd">    :return:  -  peak list sorted by decreasing (integrated intensity - fitted bkg)</span>
<span class="sd">                -peak_X,peak_Y,peak_I,peak_fwaxmaj,peak_fwaxmin,peak_inclination,Xdev,Ydev,peak_bkg</span>

<span class="sd">    for fit_peaks_gaussian == 0 (no fitdata) and local_maxima_search_method==2 (convolution)</span>
<span class="sd">        if peakposition_definition =&#39;max&#39; then X,Y,I are from the hottest pixels</span>
<span class="sd">        if peakposition_definition =&#39;center&#39; then X,Y are blob center and I the hottest blob pixel</span>

<span class="sd">    .. warning:: nb of output elements depends on &#39;return_histo&#39; argument</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">return_histo</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">return_nb_raw_blobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">return_histo</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
        <span class="n">return_nb_raw_blobs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">write_execution_time</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># user input its own shaped Data array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Data_for_localMaxima</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using &#39;Data_for_localMaxima&#39; ndarray for finding local maxima&quot;</span><span class="p">)</span>
        <span class="n">Data</span> <span class="o">=</span> <span class="n">Data_for_localMaxima</span>

        <span class="c1">#         print &quot;min, max intensity&quot;, np.amin(Data), np.amax(Data)</span>
        <span class="c1"># TODO to test with VHR</span>
        <span class="n">framedim</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ttread</span> <span class="o">=</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Data are read from image file</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Data_for_localMaxima</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Data_for_localMaxima</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">Data</span><span class="p">,</span> <span class="n">framedim</span><span class="p">,</span> <span class="n">fliprot</span> <span class="o">=</span> <span class="n">IOimage</span><span class="o">.</span><span class="n">readCCDimage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                                <span class="n">stackimageindex</span><span class="o">=</span><span class="n">stackimageindex</span><span class="p">,</span>
                                                <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">,</span>
                                                <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;image from filename </span><span class="si">{}</span><span class="s2"> read!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="c1"># peak search in a single and particular region of image</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">framediminv</span> <span class="o">=</span> <span class="p">(</span><span class="n">framedim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">framedim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span> <span class="o">=</span> <span class="n">ImProc</span><span class="o">.</span><span class="n">getindices2cropArray</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">boxsizeROI</span><span class="p">,</span> <span class="n">framediminv</span><span class="p">)</span>
            <span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="n">jmin</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span> <span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">write_execution_time</span><span class="p">:</span>
            <span class="n">dtread</span> <span class="o">=</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="n">ttread</span> <span class="o">=</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Read Image. Execution time : </span><span class="si">{:.3f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtread</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_histo</span><span class="p">:</span>
            <span class="c1"># from histogram, deduces</span>
            <span class="n">min_intensity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Data</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># in case of 16 integer</span>
            <span class="n">max_intensity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Data</span><span class="p">),</span> <span class="n">Saturation_value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min_intensity&quot;</span><span class="p">,</span> <span class="n">min_intensity</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max_intensity&quot;</span><span class="p">,</span> <span class="n">max_intensity</span><span class="p">)</span>
            <span class="c1"># histo = np.histogram(Data,</span>
            <span class="c1">#     bins=np.logspace(np.log10(min_intensity), np.log10(max_intensity), num=30))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Data_for_localMaxima</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using Data_for_localMaxima for local maxima search: ---&gt;&quot;</span><span class="p">,</span> <span class="n">Data_for_localMaxima</span><span class="p">)</span>
        <span class="c1"># compute and remove background from this image</span>
        <span class="k">if</span> <span class="n">Data_for_localMaxima</span> <span class="o">==</span> <span class="s2">&quot;auto_background&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;computing background from current image &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">backgroundimage</span> <span class="o">=</span> <span class="n">ImProc</span><span class="o">.</span><span class="n">compute_autobackground_image</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">boxsizefilter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="c1"># basic substraction</span>
            <span class="n">usemask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># path to a background image file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stackimageindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use stacked images as background is not implement&quot;</span><span class="p">)</span>
            <span class="n">path_to_bkgfile</span> <span class="o">=</span> <span class="n">Data_for_localMaxima</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using image file </span><span class="si">{}</span><span class="s2"> as background&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_bkgfile</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backgroundimage</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">IOimage</span><span class="o">.</span><span class="n">readCCDimage</span><span class="p">(</span><span class="n">path_to_bkgfile</span><span class="p">,</span>
                                                                        <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not seem to be a path file &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_bkgfile</span><span class="p">))</span>

            <span class="n">usemask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing background for local maxima search&quot;</span><span class="p">)</span>
        <span class="n">Data</span> <span class="o">=</span> <span class="n">ImProc</span><span class="o">.</span><span class="n">computefilteredimage</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">backgroundimage</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="p">,</span> <span class="n">usemask</span><span class="o">=</span><span class="n">usemask</span><span class="p">,</span>
                                                            <span class="n">formulaexpression</span><span class="o">=</span><span class="n">formulaexpression</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data.shape for local maxima&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># --- PRE SELECTION OF HOT PIXELS as STARTING POINTS FOR FITTING ---------</span>
    <span class="c1"># first method ---------- &quot;Basic Intensity Threshold&quot;</span>
    <span class="k">if</span> <span class="n">local_maxima_search_method</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using simple intensity thresholding to detect local maxima (method 1/3)&quot;</span><span class="p">)</span>
        <span class="n">peaklist</span> <span class="o">=</span> <span class="n">ImProc</span><span class="o">.</span><span class="n">LocalMaxima_from_thresholdarray</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">IntensityThreshold</span><span class="o">=</span><span class="n">IntensityThreshold</span><span class="p">,</span>
                                                    <span class="n">rois</span><span class="o">=</span><span class="n">listrois</span><span class="p">,</span>
                                                    <span class="n">framedim</span><span class="o">=</span><span class="n">framedim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">peaklist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len(peaklist)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">))</span>

            <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">))</span> <span class="o">*</span> <span class="n">IntensityThreshold</span>

            <span class="n">ComputeIpixmax</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># second method ----------- &quot;Local Maxima in a box by shift array method&quot;</span>
    <span class="k">if</span> <span class="n">local_maxima_search_method</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
        <span class="c1"># flat top peaks (e.g. saturation) are NOT well detected</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using shift arrays to detect local maxima (method 2/3)&quot;</span><span class="p">)</span>
        <span class="n">peaklist</span><span class="p">,</span> <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">ImProc</span><span class="o">.</span><span class="n">LocalMaxima_ShiftArrays</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span>
                                        <span class="n">framedim</span><span class="o">=</span><span class="n">framedim</span><span class="p">,</span>
                                        <span class="n">IntensityThreshold</span><span class="o">=</span><span class="n">IntensityThreshold</span><span class="p">,</span>
                                        <span class="n">Saturation_value</span><span class="o">=</span><span class="n">Saturation_value_flatpeak</span><span class="p">,</span>
                                        <span class="n">boxsize_for_probing_minimal_value_background</span><span class="o">=</span><span class="n">boxsize</span><span class="p">,</span>  <span class="c1"># 30</span>
                                        <span class="n">pixeldistance_remove_duplicates</span><span class="o">=</span><span class="n">PixelNearRadius</span><span class="p">,</span>  <span class="c1"># 25</span>
                                        <span class="n">nb_of_shift</span><span class="o">=</span><span class="n">boxsize</span><span class="p">)</span>  <span class="c1"># 25</span>

        <span class="n">ComputeIpixmax</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># third method: ------------ &quot;Convolution by a gaussian kernel&quot;</span>
    <span class="k">if</span> <span class="n">local_maxima_search_method</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using mexican hat convolution to detect local maxima (method 3/3)&quot;</span><span class="p">)</span>

        <span class="n">peakValConvolve</span><span class="p">,</span> <span class="n">boxsizeConvolve</span><span class="p">,</span> <span class="n">central_radiusConvolve</span> <span class="o">=</span> <span class="n">paramsHat</span>

        <span class="n">Candidates</span> <span class="o">=</span> <span class="n">ImProc</span><span class="o">.</span><span class="n">LocalMaxima_KernelConvolution</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span>
                                        <span class="n">framedim</span><span class="o">=</span><span class="n">framedim</span><span class="p">,</span>
                                        <span class="n">peakValConvolve</span><span class="o">=</span><span class="n">peakValConvolve</span><span class="p">,</span>
                                        <span class="n">boxsizeConvolve</span><span class="o">=</span><span class="n">boxsizeConvolve</span><span class="p">,</span>
                                        <span class="n">central_radiusConvolve</span><span class="o">=</span><span class="n">central_radiusConvolve</span><span class="p">,</span>
                                        <span class="n">thresholdConvolve</span><span class="o">=</span><span class="n">thresholdConvolve</span><span class="p">,</span>  <span class="c1"># 600 for CdTe</span>
                                        <span class="n">connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">IntensityThreshold</span><span class="o">=</span><span class="n">IntensityThreshold</span><span class="p">,</span>
                                        <span class="n">boxsize_for_probing_minimal_value_background</span><span class="o">=</span><span class="n">PixelNearRadius</span><span class="p">,</span>
                                        <span class="n">return_nb_raw_blobs</span><span class="o">=</span><span class="n">return_nb_raw_blobs</span><span class="p">,</span>
                                        <span class="n">peakposition_definition</span><span class="o">=</span><span class="n">peakposition_definition</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Candidates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No local maxima found, change peak search parameters !!!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">return_nb_raw_blobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">peaklist</span><span class="p">,</span> <span class="n">Ipixmax</span><span class="p">,</span> <span class="n">nbrawblobs</span> <span class="o">=</span> <span class="n">Candidates</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peaklist</span><span class="p">,</span> <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">Candidates</span>

        <span class="c1">#         print &quot;len(peaklist)&quot;, peaklist.shape</span>
        <span class="c1">#         print &quot;Ipixmax&quot;, Ipixmax.shape</span>
        <span class="n">ComputeIpixmax</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#         print &quot;Ipixmax after convolution method&quot;, Ipixmax</span>
    <span class="c1"># -------------------------------------------------------------</span>
    <span class="c1"># --- END of blobs search methods calls</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">peaklist</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">peaklist</span> <span class="ow">is</span> <span class="p">[]</span>
        <span class="ow">or</span> <span class="n">peaklist</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No local maxima found, change peak search parameters !!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># pixel origin correction due to ROI croping</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">center</span>  <span class="c1"># TODO: to ne checked !!</span>
        <span class="n">peaklist</span> <span class="o">=</span> <span class="n">peaklist</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">write_execution_time</span><span class="p">:</span>
        <span class="n">dtsearch</span> <span class="o">=</span> <span class="n">ttt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ttread</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Local maxima search. Execution time : </span><span class="si">{:.3f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtsearch</span><span class="p">))</span>

    <span class="c1"># removing some duplicates ------------</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nb_peaks_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span>
        <span class="c1">#         print &quot;%d peaks in peaklist before purge&quot; % nb_peaks_before</span>
        <span class="c1">#         print &#39;peaklist&#39;,in peaklist before purge</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">NumberMaxofFits</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOO MUCH peaks to handle.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(in PeakSearch) It may stuck the computer.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Try to reduce the number of Local Maxima or</span><span class="se">\n</span><span class="s2"> reduce &quot;</span>
                    <span class="s2">&quot;NumberMaxofFits in PeakSearch()&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">Xpeaklist</span><span class="p">,</span> <span class="n">Ypeaklist</span><span class="p">,</span> <span class="n">tokeep</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">removeClosePoints</span><span class="p">(</span><span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                                                                <span class="n">dist_tolerance</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">peaklist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Xpeaklist</span><span class="p">,</span> <span class="n">Ypeaklist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Ipixmax</span><span class="p">,</span> <span class="n">tokeep</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keep </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2"> initial peaks (ready for peak positions and shape fitting)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">),</span> <span class="n">nb_peaks_before</span><span class="p">))</span>
    <span class="c1"># -----------------------------------------------</span>

    <span class="c1"># remove black listed peaks option</span>
    <span class="k">if</span> <span class="n">Remove_BlackListedPeaks_fromfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">data_peak_blacklisted</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">Remove_BlackListedPeaks_fromfile</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">#         print &quot;data_peak_blacklisted&quot;, data_peak_blacklisted</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_peak_blacklisted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">XY_blacklisted</span> <span class="o">=</span> <span class="n">data_peak_blacklisted</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="p">(</span><span class="n">peakX</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tokeep</span><span class="p">)</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">removeClosePoints_two_sets</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">XY_blacklisted</span><span class="p">,</span>
                                                        <span class="n">dist_tolerance</span><span class="o">=</span><span class="n">maxPixelDistanceRejection</span><span class="p">,</span>
                                                        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">npeak_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">npeak_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peakX</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Removed </span><span class="si">{}</span><span class="s2"> (over </span><span class="si">{}</span><span class="s2">) peaks belonging to the blacklist </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">npeak_before</span> <span class="o">-</span> <span class="n">npeak_after</span><span class="p">,</span>
                    <span class="n">npeak_before</span><span class="p">,</span>
                    <span class="n">Remove_BlackListedPeaks_fromfile</span><span class="p">))</span>

            <span class="c1">#             print &quot;peaklist before&quot;, peaklist</span>
            <span class="c1">#             print &quot;peakX, peakY blacklisted&quot;, XY_blacklisted</span>

            <span class="n">peaklist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">peaklist</span><span class="p">,</span> <span class="n">tokeep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Ipixmax</span> <span class="o">=</span> <span class="n">Ipixmax</span><span class="p">[</span><span class="n">tokeep</span><span class="p">]</span>

    <span class="c1">#             print &quot;peaklist after blacklist removal&quot;, peaklist</span>

    <span class="c1"># ---- ----------- no FITTING ----------------------------</span>

    <span class="c1"># NO FIT  and return raw list of local maxima</span>
    <span class="k">if</span> <span class="n">fit_peaks_gaussian</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">position_definition</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># XMAS like offset</span>
            <span class="n">peaklist</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">position_definition</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># fit2D offset</span>
            <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">framedim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> local maxima found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;20 first peaks&quot;</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>

        <span class="c1"># tabpeak mimics the array built after fitting procedures</span>
        <span class="n">tabpeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">tabpeak</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">tabpeak</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peaklist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">tabpeak</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ipixmax</span>
        <span class="c1"># return tabpeak, peaklist, peaklist, peaklist  # no fitdata return raw list of local maxima</span>
        <span class="n">lastelem</span> <span class="o">=</span> <span class="n">peaklist</span>
        <span class="k">if</span> <span class="n">return_nb_raw_blobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lastelem</span> <span class="o">=</span> <span class="n">nbrawblobs</span>

        <span class="k">return</span> <span class="n">tabpeak</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">,</span> <span class="n">lastelem</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">peaklist</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">peaklist</span> <span class="ow">is</span> <span class="p">[]</span>
        <span class="ow">or</span> <span class="n">peaklist</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No local maxima found, no peaks to fit !!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># ----  ---------------FITTING ----------------------------</span>
    <span class="c1"># gaussian fitdata</span>
    <span class="k">elif</span> <span class="n">fit_peaks_gaussian</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">type_of_function</span> <span class="o">=</span> <span class="s2">&quot;gaussian&quot;</span>

    <span class="c1"># lorentzian fitdata</span>
    <span class="k">elif</span> <span class="n">fit_peaks_gaussian</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">type_of_function</span> <span class="o">=</span> <span class="s2">&quot;lorentzian&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;optional fit_peaks_gaussian value is not understood! Must be 0,1 or 2&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*****************&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> local maxima found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaklist</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Fitting of each local maxima</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#    print &quot;framedim&quot;, framedim</span>
    <span class="c1">#    print &quot;offset&quot;, offset</span>
    <span class="c1">#    print &quot;formatdata&quot;, formatdata</span>
    <span class="c1">#    print &quot;fliprot&quot;, fliprot</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">position_start</span> <span class="o">=</span> <span class="s2">&quot;centers&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">position_start</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span>

    <span class="c1"># if Data_for_localMaxima will be used for refining peak positions</span>
    <span class="k">if</span> <span class="n">Fit_with_Data_for_localMaxima</span><span class="p">:</span>
        <span class="n">Data_to_Fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">framedim</span><span class="p">,</span> <span class="n">fliprot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Data_to_Fit</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">fitoneimage_manypeaks</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                <span class="n">peaklist</span><span class="p">,</span>
                                <span class="n">boxsize</span><span class="p">,</span>
                                <span class="n">stackimageindex</span><span class="p">,</span>
                                <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">,</span>
                                <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">position_start</span><span class="o">=</span><span class="n">position_start</span><span class="p">,</span>
                                <span class="n">type_of_function</span><span class="o">=</span><span class="n">type_of_function</span><span class="p">,</span>
                                <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                <span class="n">FitPixelDev</span><span class="o">=</span><span class="n">FitPixelDev</span><span class="p">,</span>
                                <span class="n">Ipixmax</span><span class="o">=</span><span class="n">Ipixmax</span><span class="p">,</span>
                                <span class="n">MaxIntensity</span><span class="o">=</span><span class="n">Saturation_value</span><span class="p">,</span>
                                <span class="n">MinIntensity</span><span class="o">=</span><span class="n">MinIntensity</span><span class="p">,</span>
                                <span class="n">PeakSizeRange</span><span class="o">=</span><span class="n">PeakSizeRange</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                <span class="n">position_definition</span><span class="o">=</span><span class="n">position_definition</span><span class="p">,</span>
                                <span class="n">NumberMaxofFits</span><span class="o">=</span><span class="n">NumberMaxofFits</span><span class="p">,</span>
                                <span class="n">ComputeIpixmax</span><span class="o">=</span><span class="n">ComputeIpixmax</span><span class="p">,</span>
                                <span class="n">use_data_corrected</span><span class="o">=</span><span class="n">Data_to_Fit</span><span class="p">,</span>
                                <span class="n">reject_negative_baseline</span><span class="o">=</span><span class="n">reject_negative_baseline</span><span class="p">)</span></div>


<div class="viewcode-block" id="peaksearch_on_Image"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.peaksearch_on_Image">[docs]</a><span class="k">def</span> <span class="nf">peaksearch_on_Image</span><span class="p">(</span><span class="n">filename_in</span><span class="p">,</span> <span class="n">pspfile</span><span class="p">,</span> <span class="n">background_flag</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="n">blacklistpeaklist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                        <span class="n">dictPeakSearch</span><span class="o">=</span><span class="p">{},</span>
                                                        <span class="n">CCDLabel</span><span class="o">=</span><span class="s2">&quot;MARCCD165&quot;</span><span class="p">,</span>
                                                        <span class="n">outputfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                        <span class="n">psdict_Convolve</span><span class="o">=</span><span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a peaksearch by using .psp file</span>

<span class="sd">    # still not very used and checked?</span>
<span class="sd">    # missing dictPeakSearch   as function argument for formulaexpression  or dict_param??</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dict_param</span> <span class="o">=</span> <span class="n">readPeakSearchConfigFile</span><span class="p">(</span><span class="n">pspfile</span><span class="p">)</span>

    <span class="n">Data_for_localMaxima</span><span class="p">,</span> <span class="n">formulaexpression</span> <span class="o">=</span> <span class="n">read_background_flag</span><span class="p">(</span><span class="n">background_flag</span><span class="p">)</span>

    <span class="n">blacklistedpeaks_file</span> <span class="o">=</span> <span class="n">set_blacklist_filepath</span><span class="p">(</span><span class="n">blacklistpeaklist</span><span class="p">)</span>

    <span class="n">dict_param</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data_for_localMaxima</span>
    <span class="n">dict_param</span><span class="p">[</span><span class="s2">&quot;formulaexpression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formulaexpression</span>
    <span class="n">dict_param</span><span class="p">[</span><span class="s2">&quot;Remove_BlackListedPeaks_fromfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blacklistedpeaks_file</span>

    <span class="c1"># create a data considered as background from an imagefile</span>
    <span class="n">BackgroundImageCreated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flag_for_backgroundremoval</span> <span class="o">=</span> <span class="n">dict_param</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span>

    <span class="c1"># flag_for_backgroundremoval is a file path to an imagefile</span>
    <span class="c1"># create background data: dataimage_bkg</span>
    <span class="k">if</span> <span class="n">flag_for_backgroundremoval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto_background&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">flag_for_backgroundremoval</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

        <span class="n">fullpath_backgroundimage</span> <span class="o">=</span> <span class="n">psdict_Convolve</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span>

        <span class="c1">#         print &quot;fullpath_backgroundimage &quot;, fullpath_backgroundimage</span>

        <span class="c1"># dirname_bkg, imagefilename_bkg = os.path.split(fullpath_backgroundimage)</span>

        <span class="c1"># CCDlabel_bkg = CCDLabel</span>

        <span class="n">BackgroundImageCreated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;consider dataimagefile </span><span class="si">{}</span><span class="s2"> as background&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullpath_backgroundimage</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;formulaexpression&quot;</span> <span class="ow">in</span> <span class="n">dictPeakSearch</span><span class="p">:</span>
            <span class="n">formulaexpression</span> <span class="o">=</span> <span class="n">dictPeakSearch</span><span class="p">[</span><span class="s2">&quot;formulaexpression&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missing &quot;formulaexpression&quot; to operate on images before peaksearch in &#39;</span>                                    <span class="s1">&#39;peaksearch_fileseries()&#39;</span><span class="p">)</span>

        <span class="c1"># saturationlevel = DictLT.dict_CCD[CCDLabel][2]</span>

        <span class="c1"># dataimage_corrected = applyformula_on_images(dataimage_raw,</span>
        <span class="c1">#                                             dataimage_bkg,</span>
        <span class="c1">#                                             formulaexpression=formulaexpression,</span>
        <span class="c1">#                                             SaturationLevel=saturationlevel,</span>
        <span class="c1">#                                             clipintensities=True)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;using </span><span class="si">{}</span><span class="s2"> in peaksearch_fileseries&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formulaexpression</span><span class="p">))</span>

        <span class="c1"># for finding local maxima in image from formula</span>
        <span class="n">psdict_Convolve</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullpath_backgroundimage</span>

        <span class="c1"># for fitting peaks in image from formula</span>
        <span class="n">psdict_Convolve</span><span class="p">[</span><span class="s2">&quot;reject_negative_baseline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">psdict_Convolve</span><span class="p">[</span><span class="s2">&quot;formulaexpression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formulaexpression</span>
        <span class="n">psdict_Convolve</span><span class="p">[</span><span class="s2">&quot;Fit_with_Data_for_localMaxima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">Res</span> <span class="o">=</span> <span class="n">PeakSearch</span><span class="p">(</span><span class="n">filename_in</span><span class="p">,</span>
                    <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLabel</span><span class="p">,</span>
                    <span class="n">Saturation_value</span><span class="o">=</span><span class="n">DictLT</span><span class="o">.</span><span class="n">dict_CCD</span><span class="p">[</span><span class="n">CCDLabel</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">Saturation_value_flatpeak</span><span class="o">=</span><span class="n">DictLT</span><span class="o">.</span><span class="n">dict_CCD</span><span class="p">[</span><span class="n">CCDLabel</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                    <span class="o">**</span><span class="n">psdict_Convolve</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Res</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No peak found for image file: &quot;</span><span class="p">,</span> <span class="n">filename_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># write file with comments</span>
    <span class="n">Isorted</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Res</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">outputfilename</span><span class="p">:</span>

        <span class="n">params_comments</span> <span class="o">=</span> <span class="s2">&quot;Peak Search and Fit parameters</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">params_comments</span> <span class="o">+=</span> <span class="s2">&quot;# </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;CCDLabel&quot;</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">psdict_Convolve</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">BackgroundImageCreated</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">,):</span>
                <span class="n">params_comments</span> <span class="o">+=</span> <span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">BackgroundImageCreated</span><span class="p">:</span>
            <span class="n">params_comments</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;# &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;Data_for_localMaxima&quot;</span>
                                <span class="o">+</span> <span class="s2">&quot; : </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullpath_backgroundimage</span><span class="p">))</span>
        <span class="c1"># .dat file extension is done in writefile_Peaklist()</span>

        <span class="n">IOLT</span><span class="o">.</span><span class="n">writefile_Peaklist</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">),</span>
                                <span class="n">Isorted</span><span class="p">,</span>
                                <span class="n">overwrite</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">initialfilename</span><span class="o">=</span><span class="n">filename_in</span><span class="p">,</span>
                                <span class="n">comments</span><span class="o">=</span><span class="n">params_comments</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Isorted</span></div>


<span class="c1"># -------------------  CONFIG file functions (.psp)</span>
<span class="c1"># import configparser as CONF</span>

<span class="c1"># --- ---- Local maxima and fit parameters</span>
<span class="n">CONVERTKEY_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fit_peaks_gaussian&quot;</span><span class="p">:</span> <span class="s2">&quot;fit_peaks_gaussian&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;position_definition&quot;</span><span class="p">:</span> <span class="s2">&quot;position_definition&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;local_maxima_search_method&quot;</span><span class="p">:</span> <span class="s2">&quot;local_maxima_search_method&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;intensitythreshold&quot;</span><span class="p">:</span> <span class="s2">&quot;IntensityThreshold&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;thresholdconvolve&quot;</span><span class="p">:</span> <span class="s2">&quot;thresholdConvolve&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;boxsize&quot;</span><span class="p">:</span> <span class="s2">&quot;boxsize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pixelnearradius&quot;</span><span class="p">:</span> <span class="s2">&quot;PixelNearRadius&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xtol&quot;</span><span class="p">:</span> <span class="s2">&quot;xtol&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fitpixeldev&quot;</span><span class="p">:</span> <span class="s2">&quot;FitPixelDev&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;maxpixeldistancerejection&quot;</span><span class="p">:</span> <span class="s2">&quot;maxPixelDistanceRejection&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;maxpeaksize&quot;</span><span class="p">:</span> <span class="s2">&quot;MaxPeakSize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;minpeaksize&quot;</span><span class="p">:</span> <span class="s2">&quot;MinPeakSize&quot;</span><span class="p">}</span>

<span class="n">LIST_OPTIONS_PEAKSEARCH</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;local_maxima_search_method&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;IntensityThreshold&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;thresholdConvolve&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;boxsize&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;PixelNearRadius&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;fit_peaks_gaussian&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;xtol&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;FitPixelDev&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;position_definition&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;maxPixelDistanceRejection&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;MinPeakSize&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;MaxPeakSize&quot;</span><span class="p">]</span>

<span class="n">LIST_OPTIONS_TYPE_PEAKSEARCH</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;integer flag&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;integer count&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;float count&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;integer pixel&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;integer pixel&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;integer flag&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;float pixel&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;integer flag&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;float&quot;</span><span class="p">]</span>

<span class="n">LIST_OPTIONS_VALUESPARAMS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CONVERTKEY_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LIST_OPTIONS_PEAKSEARCH</span><span class="p">)</span>
                            <span class="o">!=</span> <span class="n">LIST_OPTIONS_TYPE_PEAKSEARCH</span> <span class="o">!=</span> <span class="n">LIST_OPTIONS_VALUESPARAMS</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;Lists of parameters for config .psp file do not have the same length (readmccd.py)&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="savePeakSearchConfigFile"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.savePeakSearchConfigFile">[docs]</a><span class="k">def</span> <span class="nf">savePeakSearchConfigFile</span><span class="p">(</span><span class="n">dict_param</span><span class="p">,</span> <span class="n">outputfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; save peak search parameters in .psp file&quot;&quot;&quot;</span>
    <span class="c1"># save peaksearch parameter in config file</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;PeakSearch&quot;</span><span class="p">)</span>

    <span class="n">params_comments</span> <span class="o">=</span> <span class="s2">&quot;Peak Search and Fit parameters</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_param</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">params_comments</span> <span class="o">+=</span> <span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;PeakSearch&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">outputfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outputfilename</span> <span class="o">=</span> <span class="s2">&quot;PeakSearch.psp&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputfilename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.psp&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">outputfilename</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">outputfilename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputfilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.psp&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputfilename</span> <span class="o">+=</span> <span class="s2">&quot;.psp&quot;</span>

    <span class="c1"># Writing configuration file to &#39;PeakSearch.cfg&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outputfilename</span></div>


<div class="viewcode-block" id="readPeakSearchConfigFile"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.readPeakSearchConfigFile">[docs]</a><span class="k">def</span> <span class="nf">readPeakSearchConfigFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; read peak search parameters in .psp file&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="c1">#    config = MyCasePreservingConfigParser()</span>

    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;PeakSearch&quot;</span><span class="p">,):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;wrong section name in config file </span><span class="si">{}</span><span class="s2">. Must be in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;IndexRefine&quot;</span><span class="p">))</span>

    <span class="n">dict_param</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">list_options</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">list_options</span><span class="p">:</span>

        <span class="c1">#         print &quot;\n option\n&quot;, option</span>
        <span class="k">for</span> <span class="n">option_ref</span><span class="p">,</span> <span class="n">option_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">LIST_OPTIONS_PEAKSEARCH</span><span class="p">,</span> <span class="n">LIST_OPTIONS_TYPE_PEAKSEARCH</span><span class="p">):</span>

            <span class="c1">#             print &quot;option_ref, option_type&quot;, option_ref, option_type</span>

            <span class="k">if</span> <span class="n">option_ref</span> <span class="o">==</span> <span class="n">option</span> <span class="ow">or</span> <span class="n">option_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">option</span><span class="p">:</span>

                <span class="c1">#                 print &quot;BINGO! I m able to read %s&quot; % option_ref</span>
                <span class="c1">#                 print &quot;data type should be: %s&quot; % option_type</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">optionkey</span> <span class="o">=</span> <span class="n">CONVERTKEY_dict</span><span class="p">[</span><span class="n">option_ref</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">optionkey</span> <span class="o">=</span> <span class="n">option_ref</span>

                <span class="n">option_lower</span> <span class="o">=</span> <span class="n">option_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">option_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">):</span>
                        <span class="n">dict_param</span><span class="p">[</span><span class="n">optionkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option_lower</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">option_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;float&quot;</span><span class="p">,)):</span>
                        <span class="n">dict_param</span><span class="p">[</span><span class="n">optionkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option_lower</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dict_param</span><span class="p">[</span><span class="n">optionkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option_lower</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Value of option &#39;</span><span class="si">{}</span><span class="s2">&#39; has not the correct type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="k">break</span>

    <span class="c1">#     print &quot;Finally, I ve read these parameters&quot;</span>
    <span class="c1">#     print dict_param</span>
    <span class="k">return</span> <span class="n">dict_param</span></div>


<div class="viewcode-block" id="read_background_flag"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.read_background_flag">[docs]</a><span class="k">def</span> <span class="nf">read_background_flag</span><span class="p">(</span><span class="n">background_flag</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    interpret the background flag (field used in FileSeries/Peak_Search.py)</span>

<span class="sd">    return two values to put in dict_param of peaksearch_series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formulaexpression</span> <span class="o">=</span> <span class="s2">&quot;A-B&quot;</span>

    <span class="k">if</span> <span class="n">background_flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;YES&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
        <span class="n">Data_for_localMaxima</span> <span class="o">=</span> <span class="s2">&quot;auto_background&quot;</span>
    <span class="k">elif</span> <span class="n">background_flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;NO&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">):</span>
        <span class="n">Data_for_localMaxima</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># should be a path to a single imagefile</span>
        <span class="c1"># (plus optionally a mathematical formula expression)</span>

        <span class="n">ressplit</span> <span class="o">=</span> <span class="n">background_flag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ressplit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">background_flag</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ressplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">filepath</span><span class="p">,</span> <span class="n">formulaexpression</span> <span class="o">=</span> <span class="n">ressplit</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> for background is does not exist&#39;</span><span class="o">%</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">Data_for_localMaxima</span> <span class="o">=</span> <span class="n">filepath</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image file path used for background&quot;</span><span class="p">,</span> <span class="n">Data_for_localMaxima</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Data_for_localMaxima</span><span class="p">,</span> <span class="n">formulaexpression</span></div>


<span class="k">def</span> <span class="nf">set_blacklist_filepath</span><span class="p">(</span><span class="n">filepathstr</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; return None or path to file containing black listed spots list&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filepathstr</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">Remove_BlackListedPeaks_fromfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># fullpath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Remove_BlackListedPeaks_fromfile</span> <span class="o">=</span> <span class="n">filepathstr</span>
    <span class="k">return</span> <span class="n">Remove_BlackListedPeaks_fromfile</span>

<span class="k">def</span> <span class="nf">set_rois_file</span><span class="p">(</span><span class="n">filepathstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return None or path to file containing rois list&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filepathstr</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">roisfilepath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># fullpath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">roisfilepath</span> <span class="o">=</span> <span class="n">filepathstr</span>
    <span class="k">return</span> <span class="n">roisfilepath</span>




<span class="c1"># --- -------------- multiple file peak search</span>
<div class="viewcode-block" id="peaksearch_fileseries"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.peaksearch_fileseries">[docs]</a><span class="k">def</span> <span class="nf">peaksearch_fileseries</span><span class="p">(</span><span class="n">fileindexrange</span><span class="p">,</span>
                            <span class="n">filenameprefix</span><span class="p">,</span>
                            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">nbdigits</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">dirname_in</span><span class="o">=</span><span class="s2">&quot;/home/micha/LaueProjects/AxelUO2&quot;</span><span class="p">,</span>
                            <span class="n">outputname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">dirname_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">CCDLABEL</span><span class="o">=</span><span class="s2">&quot;MARCCD165&quot;</span><span class="p">,</span>
                            <span class="n">KF_DIRECTION</span><span class="o">=</span><span class="s2">&quot;Z&gt;0&quot;</span><span class="p">,</span>  <span class="c1"># not used yet</span>
                            <span class="n">dictPeakSearch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    peaksearch function to be called for multi or single processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"> ***** Starting peaksearch_fileseries()  *****</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># peak search Parameters update from .psp file</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictPeakSearch</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dictPeakSearch</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="s2">&quot;MinPeakSize&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">:</span>
        <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;MinPeakSize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.65</span>
        <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;MaxPeakSize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default values for minimal and maximal peaksize are used!. Resp. 0.65 and 3 pixels.&quot;</span><span class="p">)</span>

    <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;PeakSizeRange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;MinPeakSize&quot;</span><span class="p">]),</span>
                                                <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;MaxPeakSize&quot;</span><span class="p">]))</span>
    <span class="k">del</span> <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;MinPeakSize&quot;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;MaxPeakSize&quot;</span><span class="p">]</span>

    <span class="c1"># ----handle reading of filename</span>
    <span class="c1"># special case for _mar.tif files...</span>
    <span class="k">if</span> <span class="n">nbdigits</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;varying&quot;</span><span class="p">,):</span>
        <span class="c1"># DEFAULT_DIGITSENCODING = 4</span>
        <span class="c1"># encodingdigits = &quot;{&quot; + &quot;:0{}&quot;.format(DEFAULT_DIGITSENCODING) + &quot;}&quot;</span>
        <span class="k">pass</span>
    <span class="c1"># normal case</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># encodingdigits = &quot;{&quot; + &quot;:0{}&quot;.format(int(nbdigits)) + &quot;}&quot;</span>
        <span class="n">nbdigits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbdigits</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;.mccd&quot;</span>

    <span class="k">if</span> <span class="n">dirname_in</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filenameprefix_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname_in</span><span class="p">,</span> <span class="n">filenameprefix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filenameprefix_in</span> <span class="o">=</span> <span class="n">filenameprefix</span>

    <span class="c1"># filename_wo_path = filenameprefix_in.split(&quot;/&quot;)[-1]</span>

    <span class="k">if</span> <span class="n">outputname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix_outputname</span> <span class="o">=</span> <span class="n">outputname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix_outputname</span> <span class="o">=</span> <span class="n">filenameprefix</span>  <span class="c1"># filename_wo_path[:-len(file_extension) - 1]</span>

    <span class="k">if</span> <span class="n">dirname_out</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix_outputname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname_out</span><span class="p">,</span> <span class="n">prefix_outputname</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileindexrange</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">fileindexrange</span> <span class="o">=</span> <span class="n">fileindexrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fileindexrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span>

    <span class="c1"># create a data considered as background from an imagefile</span>
    <span class="n">BackgroundImageCreated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flag_for_backgroundremoval</span> <span class="o">=</span> <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span>

    <span class="c1"># flag_for_backgroundremoval is a file path to an imagefile</span>
    <span class="c1"># create background data: dataimage_bkg</span>
    <span class="k">if</span> <span class="n">flag_for_backgroundremoval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto_background&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">flag_for_backgroundremoval</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

        <span class="n">fullpath_backgroundimage</span> <span class="o">=</span> <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span>


        <span class="c1"># dirname_bkg, imagefilename_bkg = os.path.split(fullpath_backgroundimage)</span>

        <span class="c1"># CCDlabel_bkg = CCDLABEL</span>

        <span class="c1"># (dataimage_bkg, _, _) = IOimage.readCCDimage(imagefilename_bkg,</span>
        <span class="c1">#                                                             CCDLabel=CCDlabel_bkg,</span>
        <span class="c1">#                                                             dirname=dirname_bkg)</span>

        <span class="n">BackgroundImageCreated</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">fileindex</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fileindexrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">fileindexrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">fileindexrange</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
        <span class="c1"># TODO to move this branching elsewhere (readmccd)</span>
        <span class="k">if</span> <span class="n">suffix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_mar.tif&quot;</span><span class="p">):</span>
            <span class="n">filename_in</span> <span class="o">=</span> <span class="n">IOimage</span><span class="o">.</span><span class="n">setfilename</span><span class="p">(</span><span class="n">filenameprefix_in</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileindex</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span>
                                                                                        <span class="n">fileindex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#             filename_in = filenameprefix_in + encodingdigits % fileindex + suffix</span>
            <span class="n">filename_in</span> <span class="o">=</span> <span class="n">filenameprefix_in</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fileindex</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">nbdigits</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span>

        <span class="n">tirets</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> PeakSearch on filename </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}{}{}</span><span class="s2">n</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tirets</span><span class="p">,</span> <span class="n">tirets</span><span class="p">,</span> <span class="n">filename_in</span><span class="p">,</span> <span class="n">tirets</span><span class="p">,</span> <span class="n">tirets</span><span class="p">,</span> <span class="n">tirets</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename_in</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">*******</span><span class="se">\n</span><span class="s2">Something wrong with the filename: </span><span class="si">{}</span><span class="s2">. Please check &quot;</span>
                                            <span class="s2">&quot;carefully the filename!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename_in</span><span class="p">))</span>

        <span class="c1"># remove a single image (considered as background) to current image</span>
        <span class="k">if</span> <span class="n">BackgroundImageCreated</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;consider dataimagefile </span><span class="si">{}</span><span class="s2"> as background&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullpath_backgroundimage</span><span class="p">))</span>
            <span class="c1"># (dataimage_raw, _, _) = IOimage.readCCDimage(filename_in, CCDLabel=CCDLABEL,</span>
            <span class="c1">#                                                                         dirname=None)</span>

            <span class="k">if</span> <span class="s2">&quot;formulaexpression&quot;</span> <span class="ow">in</span> <span class="n">dictPeakSearch</span><span class="p">:</span>
                <span class="n">formulaexpression</span> <span class="o">=</span> <span class="n">dictPeakSearch</span><span class="p">[</span><span class="s2">&quot;formulaexpression&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missing &quot;formulaexpression&quot; to operate on images before &#39;</span>
                                <span class="s1">&#39;peaksearch in peaksearch_fileseries()&#39;</span><span class="p">)</span>

            <span class="c1"># saturationlevel = DictLT.dict_CCD[CCDLABEL][2]</span>

            <span class="c1"># dataimage_corrected = applyformula_on_images(dataimage_raw,</span>
            <span class="c1">#                                             dataimage_bkg,</span>
            <span class="c1">#                                             formulaexpression=formulaexpression,</span>
            <span class="c1">#                                             SaturationLevel=saturationlevel,</span>
            <span class="c1">#                                             clipintensities=True)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;using </span><span class="si">{}</span><span class="s2"> in peaksearch_fileseries&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formulaexpression</span><span class="p">))</span>

            <span class="c1">#             print &#39;Imin Imax dataimage_raw&#39;, np.amin(A), np.amax(A)</span>
            <span class="c1">#             print &#39;Imin Imax dataimage_bkg&#39;, np.amin(B), np.amax(B)</span>

            <span class="c1"># for finding local maxima in image from formula</span>
            <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullpath_backgroundimage</span>

            <span class="c1"># for fitting peaks in image from formula</span>
            <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;reject_negative_baseline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;formulaexpression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formulaexpression</span>
            <span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">[</span><span class="s2">&quot;Fit_with_Data_for_localMaxima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#             print &#39;Imin Imax dataimage_corrected&#39;, np.amin(dataimage_corrected), np.amax(dataimage_corrected)</span>

        <span class="c1"># --------------------------</span>
        <span class="c1"># launch peaksearch</span>
        <span class="c1"># -----------------------</span>
        <span class="n">Res</span> <span class="o">=</span> <span class="n">PeakSearch</span><span class="p">(</span><span class="n">filename_in</span><span class="p">,</span> <span class="n">CCDLabel</span><span class="o">=</span><span class="n">CCDLABEL</span><span class="p">,</span>
                            <span class="n">Saturation_value</span><span class="o">=</span><span class="n">DictLT</span><span class="o">.</span><span class="n">dict_CCD</span><span class="p">[</span><span class="n">CCDLABEL</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">Saturation_value_flatpeak</span><span class="o">=</span><span class="n">DictLT</span><span class="o">.</span><span class="n">dict_CCD</span><span class="p">[</span><span class="n">CCDLABEL</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                            <span class="o">**</span><span class="n">PEAKSEARCHDICT_Convolve</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Res</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No peak found for image file: &quot;</span><span class="p">,</span> <span class="n">filename_in</span><span class="p">)</span>
        <span class="c1">#             Isorted, fitpeak, localpeak = None, None, None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># write file with comments</span>
            <span class="n">Isorted</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Res</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">params_comments</span> <span class="o">=</span> <span class="s2">&quot;Peak Search and Fit parameters</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">params_comments</span> <span class="o">+=</span> <span class="s2">&quot;# </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;CCDLabel&quot;</span><span class="p">,</span> <span class="n">CCDLABEL</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">PEAKSEARCHDICT_Convolve</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">BackgroundImageCreated</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Data_for_localMaxima&quot;</span><span class="p">,):</span>
                    <span class="n">params_comments</span> <span class="o">+=</span> <span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">BackgroundImageCreated</span><span class="p">:</span>
                <span class="n">params_comments</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="s2">&quot;Data_for_localMaxima&quot;</span>
                                    <span class="o">+</span> <span class="s2">&quot; : </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullpath_backgroundimage</span><span class="p">))</span>
            <span class="c1"># .dat file extension is done in writefile_Peaklist()</span>
            <span class="c1"># filename_out = prefix_outputname + encodingdigits % fileindex</span>
            <span class="c1"># TODO valid whatever</span>
            <span class="n">filename_out</span> <span class="o">=</span> <span class="n">prefix_outputname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fileindex</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">nbdigits</span><span class="p">)</span>
            <span class="n">IOLT</span><span class="o">.</span><span class="n">writefile_Peaklist</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename_out</span><span class="p">),</span>
                                        <span class="n">Isorted</span><span class="p">,</span>
                                        <span class="n">overwrite</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">initialfilename</span><span class="o">=</span><span class="n">filename_in</span><span class="p">,</span>
                                        <span class="n">comments</span><span class="o">=</span><span class="n">params_comments</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">*******************</span><span class="se">\n\n\n</span><span class="s2"> task of peaksearch COMPLETED!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="peaksearch_multiprocessing"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.peaksearch_multiprocessing">[docs]</a><span class="k">def</span> <span class="nf">peaksearch_multiprocessing</span><span class="p">(</span><span class="n">fileindexrange</span><span class="p">,</span> <span class="n">filenameprefix</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nbdigits</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                                    <span class="n">dirname_in</span><span class="o">=</span><span class="s2">&quot;/home/micha/LaueProjects/AxelUO2&quot;</span><span class="p">,</span>
                                                    <span class="n">outputname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">dirname_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">CCDLABEL</span><span class="o">=</span><span class="s2">&quot;MARCCD165&quot;</span><span class="p">,</span>
                                                    <span class="n">KF_DIRECTION</span><span class="o">=</span><span class="s2">&quot;Z&gt;0&quot;</span><span class="p">,</span>
                                                    <span class="n">dictPeakSearch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">nb_of_cpu</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    launch several processes in parallel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileindexrange</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> STEP INDEX is SET to 1 </span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">index_start</span><span class="p">,</span> <span class="n">index_final</span> <span class="o">=</span> <span class="n">fileindexrange</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need 2 file indices integers in fileindexrange=(indexstart, indexfinal)&quot;</span><span class="p">)</span>

    <span class="n">fileindexdivision</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">getlist_fileindexrange_multiprocessing</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_final</span><span class="p">,</span> <span class="n">nb_of_cpu</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1">#    fileindexrange, filenameprefix,</span>
    <span class="c1">#                          suffix=&#39;&#39;, nbdigits=4,</span>
    <span class="c1">#                          dirname_in=&#39;/home/micha/LaueProjects/AxelUO2&#39;,</span>
    <span class="c1">#                          outputname=None, dirname_out=None,</span>
    <span class="c1">#                            CCDLABEL=&#39;MARCCD165&#39;,</span>
    <span class="c1">#                            fileextension=&#39;mccd&#39;,</span>
    <span class="c1">#                            dictPeakSearch=None</span>

    <span class="c1">#    t00 = ttt.time()</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_of_cpu</span><span class="p">)):</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">peaksearch_fileseries</span><span class="p">,</span>
                                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">fileindexdivision</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                            <span class="n">filenameprefix</span><span class="p">,</span>
                                            <span class="n">suffix</span><span class="p">,</span>
                                            <span class="n">nbdigits</span><span class="p">,</span>
                                            <span class="n">dirname_in</span><span class="p">,</span>
                                            <span class="n">outputname</span><span class="p">,</span>
                                            <span class="n">dirname_out</span><span class="p">,</span>
                                            <span class="n">CCDLABEL</span><span class="p">,</span>
                                            <span class="n">KF_DIRECTION</span><span class="p">,</span>
                                            <span class="n">dictPeakSearch</span><span class="p">))</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">peaklist_dict</span><span class="p">(</span><span class="n">prefixfilename</span><span class="p">,</span> <span class="n">startindex</span><span class="p">,</span> <span class="n">finalindex</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; create a dict with key=image index and value=list of peaks &quot;&quot;&quot;</span>
    <span class="n">dict_peaks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">startindex</span><span class="p">,</span> <span class="n">finalindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">prefixfilename</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:04d}</span><span class="s2">.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">array_peaks</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">dict_peaks</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_peaks</span>

    <span class="k">return</span> <span class="n">dict_peaks</span>


<div class="viewcode-block" id="purgePeaksListFile"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.purgePeaksListFile">[docs]</a><span class="k">def</span> <span class="nf">purgePeaksListFile</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">blacklisted_XY</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove in peaklist .dat file peaks that are in blacklist</span>

<span class="sd">    :param blacklisted_XY:         [X1,Y1],[X2,Y2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_peak</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>

    <span class="n">XY</span> <span class="o">=</span> <span class="n">data_peak</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="n">blacklisted_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blacklisted_XY</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">peakX</span><span class="p">,</span> <span class="n">peakY</span><span class="p">,</span> <span class="n">tokeep</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">removeClosePoints_two_sets</span><span class="p">(</span><span class="n">XY</span><span class="p">,</span> <span class="n">blacklisted_XY</span><span class="p">,</span>
                                            <span class="n">dist_tolerance</span><span class="o">=</span><span class="n">dist_tolerance</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">peakX</span><span class="p">,</span> <span class="n">peakY</span><span class="p">,</span> <span class="n">tokeep</span></div>

<div class="viewcode-block" id="write_PurgedPeakListFile"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.write_PurgedPeakListFile">[docs]</a><span class="k">def</span> <span class="nf">write_PurgedPeakListFile</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">blacklisted_XY</span><span class="p">,</span> <span class="n">outputfilename</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                                                        <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    write a new .dat file where peaks in blacklist are omitted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#peakX, peakY, tokeep</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tokeep</span> <span class="o">=</span> <span class="n">purgePeaksListFile</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">blacklisted_XY</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>

    <span class="n">data_peak</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>

    <span class="n">new_data_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_peak</span><span class="p">,</span> <span class="n">tokeep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dirname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outputfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">outputfilename</span><span class="p">)</span>

    <span class="n">IOLT</span><span class="o">.</span><span class="n">writefile_Peaklist</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">,</span>
                            <span class="n">new_data_peak</span><span class="p">,</span>
                            <span class="n">overwrite</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">initialfilename</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span>
                            <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;Some peaks have been removed by write_PurgedPeakListFile&quot;</span><span class="p">,</span>
                            <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New peak list file </span><span class="si">{}</span><span class="s2"> has been written&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">))</span></div>


<div class="viewcode-block" id="removePeaks_inPeakList"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.removePeaks_inPeakList">[docs]</a><span class="k">def</span> <span class="nf">removePeaks_inPeakList</span><span class="p">(</span><span class="n">PeakListfilename</span><span class="p">,</span>
                            <span class="n">BlackListed_PeakListfilename</span><span class="p">,</span>
                            <span class="n">outputfilename</span><span class="p">,</span>
                            <span class="n">dist_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read peaks PeakListfilename and remove those in BlackListed_PeakListfilename</span>
<span class="sd">    and write a new peak list file</span>

<span class="sd">    .. note:: Not used ??</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_peak_blacklisted</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">BlackListed_PeakListfilename</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>

    <span class="n">XY_blacklisted</span> <span class="o">=</span> <span class="n">data_peak_blacklisted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="n">write_PurgedPeakListFile</span><span class="p">(</span><span class="n">PeakListfilename</span><span class="p">,</span>
                            <span class="n">XY_blacklisted</span><span class="p">,</span>
                            <span class="n">outputfilename</span><span class="p">,</span>
                            <span class="n">dist_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_2Peaklist"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.merge_2Peaklist">[docs]</a><span class="k">def</span> <span class="nf">merge_2Peaklist</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dirname1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dirname2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return merge spots data from two peaklists and removed duplicates within dist_tolerance (pixel)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_peak_1</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname1</span><span class="p">)</span>
    <span class="n">data_peak_2</span> <span class="o">=</span> <span class="n">IOLT</span><span class="o">.</span><span class="n">read_Peaklist</span><span class="p">(</span><span class="n">filename2</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="n">dirname2</span><span class="p">)</span>

    <span class="n">XY1</span> <span class="o">=</span> <span class="n">data_peak_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">XY2</span> <span class="o">=</span> <span class="n">data_peak_2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#XY, ind_delele_1, ind_delele_2</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ind_delele_1</span><span class="p">,</span> <span class="n">ind_delele_2</span> <span class="o">=</span> <span class="n">GT</span><span class="o">.</span><span class="n">mergelistofPoints</span><span class="p">(</span><span class="n">XY1</span><span class="p">,</span> <span class="n">XY2</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="o">=</span><span class="n">dist_tolerance</span><span class="p">,</span>
                                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data_peak_1</span><span class="p">,</span> <span class="n">ind_delele_1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data_peak_2</span><span class="p">,</span> <span class="n">ind_delele_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="writefile_mergedPeaklist"><a class="viewcode-back" href="../../PeakSearch.html#LaueTools.readmccd.writefile_mergedPeaklist">[docs]</a><span class="k">def</span> <span class="nf">writefile_mergedPeaklist</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">outputfilename</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                                    <span class="n">dirname1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                    <span class="n">dirname2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    write peaklist file from the merge of spots data from two peaklists</span>
<span class="sd">    (and removed duplicates within dist_tolerance (pixel))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">merged_data</span> <span class="o">=</span> <span class="n">merge_2Peaklist</span><span class="p">(</span>
        <span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="p">,</span> <span class="n">dirname1</span><span class="p">,</span> <span class="n">dirname2</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;Peaks from merging </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> with pixel tolerance </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">dist_tolerance</span><span class="p">)</span>
    <span class="n">IOLT</span><span class="o">.</span><span class="n">writefile_Peaklist</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">,</span> <span class="n">merged_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merged peak lists written in file: &quot;</span><span class="p">,</span> <span class="n">outputfilename</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, J.S. Micha, O. Robach., S. Tardif

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>